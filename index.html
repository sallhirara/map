<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mapping system</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
        }

        .menu-container {
            color: #333;
            display: flex;
            height: 30px;
            width: 90%;
            justify-content: flex-start;
            margin: 5px 20px;
            position: relative;
        }

        .custom-file-upload {
            color: #333;
            font-size: 20px;
            margin-right: 10px;
            display: inline-block;
            padding: 4px 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .custom-file-upload:hover {
            background-color: #ddd;
        }

        #fileUpload {
            display: none;
        }
        
        .menu-button {
            margin: 0 5px;
            padding: 5px 10px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: transparent;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #333;
        }

        .menu-button i {
            margin-left: 10px;
        }

        .menu-button:hover {
            background-color: #ddd;
        }

        .mega-menu {
            display: none;
            position: absolute;
            width: 90%;
            max-width: 500px;
            overflow-y: hidden;
            left: 5%;
            background: transparent;
            backdrop-filter: blur(5px);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            font-size: 12px;

            top: 60px; /* menu-container (30px) + margin (10px) を考慮 */
            transform: translateY(-20px); /* 初期状態で少し上に隠しておく */
            opacity: 0; /* 初期は非表示 */
            transition: transform 0.7s ease, opacity 0.7s ease, top 0.7s ease; /* アニメーションをゆっくりに変更 */

        }
      
        .mega-menu::-webkit-scrollbar {
          display: none; /* Chrome, Safari, Opera のスクロールバーを非表示 */
        }
        
        .mega-menu::before {
            content: "";
            position: absolute;
            top: -20px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-width: 10px;
            border-style: solid;
            border-color: transparent transparent #ffffff transparent;
        }


        /* -------- Summary from here --------*/
        #summary {
            border: none;
            padding: 20px;
            font-size: 12px;
        }
        /* -------- Summary to here --------*/


        /* -------- Conditions from here --------*/
        #conditions {
            border: none;
            font-size: 12px;
        }

        /* radio */
        .area-radio {
            border: none;
            margin-bottom: 5px;
          
            /*　radio items の割り付けグリッド４分割　*/
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 横に2分割 */
            grid-template-rows: repeat(1, 1fr);    /* 縦に2分割 */
            gap: 0px;                             /* 各アイテム間のスペース */             
        }

        .a-radio {
          border: none;
            padding: 6px;
            border-radius: 50px;
            display: inline-flex;
            cursor: pointer;
            transition: background 0.2s ease;
            margin: 0px;
            -webkit-tap-highlight-color: transparent;
        }

        .a-radio:hover,
        .a-radio:focus-within {
            background: rgba(159, 159, 159, 0.3); /* $secondary color in RGBA */
        }

        .a-radio input {
            vertical-align: middle;
            width: 16px;
            height: 16px;
            border-radius: 10px;
            background: none;
            border: 0;
            box-shadow: inset 0 0 0 1.5px #9F9F9F; /* $secondary color */
            appearance: none;
            padding: 0;
            margin: 0;
            transition: box-shadow 150ms cubic-bezier(0.95, 0.15, 0.5, 1.25);
            pointer-events: none;
        }

        .a-radio input:focus {
            outline: none;
        }

        .a-radio input:checked {
            box-shadow: inset 0 0 0 5px #6743ee; /* $primary color */
        }

        .a-radio span {
            vertical-align: middle;
            display: inline-block;
            line-height: 16px;
            padding: 0 8px;
        }
        /* radio */

        /* checkbox */
        .category-checkbox {
            border: none;
            margin-bottom: 5px;
            
            /*　checkbox　item の均等割り付け　*/
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 横に2分割 */
            grid-template-rows: repeat(1, 1fr);    /* 縦に2分割 */
            gap: 0px;                             /* 各アイテム間のスペース */
     
        }

        .c-checkbox {
          border: none!important;
            padding: 6px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2 ease;
            margin: 0px;
            -webkit-tap-highlight-color: transparent;
        }

        .c-checkbox:hover,
        .c-checkbox:focus-within {
            background: rgba(159, 159, 159, 0.3); /* $secondary color in RGBA */
            border-radius: 10px !important;
        }

        .c-checkbox input {
            vertical-align: middle !important;
            width: 16px !important;
            height: 16px !important;
            border-radius: 6px !important;
            background: none !important;
            border: 0 !important;
            box-shadow: inset 0 0 0 1.5px #9F9F9F !important; /* $secondary color */
            appearance: none !important;
            padding: 0 !important;
            margin: 0 !important;
            transition: box-shadow 150ms cubic-bezier(0.95, 0.15, 0.5, 1.25) !important;
            pointer-events: none !important;
        }

        .c-checkbox input:focus {
            outline: none !important;
        }

        .c-checkbox input:checked {
            box-shadow: inset 0 0 0 10px #6743ee !important; /* $primary color */
        }

        .c-checkbox input[type="checkbox"]:checked::before {
            color: lightgray !important;
        }        

        .c-checkbox span {
            vertical-align: middle;
            display: inline-block;
            line-height: 16px;
            padding: 0 8px;
        }
        /* checkbox */
        

        /* -------- Conditions to here --------*/


        /* -------- PJ List from here --------*/
        #listMenu {
            max-height: 500px;

            overflow-y: auto;
            margin: 0;
            padding: 20px 25px;
            -ms-overflow-style: none;  /* IEとEdgeでスクロールバーを非表示 */
            scrollbar-width: none;  /* Firefoxでスクロールバーを非表示 */
        }
        
        #listMenu::-webkit-scrollbar {
          display: none;
        }
        

        /*Category 1 毎 のコンテナ*/
        .layer-group {
            margin-bottom: 15px;
        }
        
        /*Category 1 のヘッダーコンテナ*/
        .main-category {
            margin-bottom: 10px;
        }

        /*Category 1 のテキスト部分*/
        .category-text {
            padding-left: 10px;
            font-size: 14px;
            font-weight: bolder;
            color: #555;
            cursor: pointer;
        }

        /* アイコンの共通スタイル */
        .toggle-icon {
            height: 18px;
            padding: 2px 5px 2px 16px;
            color: #999; /* 開いた状態で色を変更 */
        }

        /* 開いているときのスタイル */
        .toggle-icon.open {
            color: #999; /* 開いた状態で色を変更 */
        }

        /*PJ Name それぞれのコンテナ*/
        .individual-icon-container {
            margin-bottom: 5px;
        }

        .individual-icon {
            margin-left: 10px;
            cursor: alias;
        }

        input[type="checkbox"] {
            vertical-align: middle;
            appearance: none;
            width: 16px;
            height: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            display: inline-block;
        }

        input[type="checkbox"]:checked {
            font-size: 9px;
            background-color: #4caf50;
            border: 1px solid #4caf50;
            position: relative;
        }

        input[type="checkbox"]:checked::before {
            content: '\2714';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
        }

        /* -------- PJ List to here --------*/

        #map {
            position: absolute;
            height: calc(100% - 40px); /* menu-container の高さ +margin を考慮 */
            width: 100%;
            top: 40px; /* menu-container の高さ分だけ下にずらす */
        }

        .leaflet-popup-content {
            user-select: text;
        }
    </style>
</head>
<body>
    <div class="menu-container">
        <label for="fileUpload" class="custom-file-upload"><i class="fa-solid fa-file-arrow-down"></i></label>
        <input type="file" id="fileUpload" accept=".xlsx,.xlsm" />
        <button class="menu-button" onclick="toggleMenu('summary', this)">Summary<i class="fa-solid fa-caret-down"></i></button>
        <button class="menu-button" onclick="toggleMenu('conditions', this)">Conditions<i class="fa-solid fa-caret-down"></i></button>
        <button class="menu-button" onclick="toggleMenu('listMenu', this)">PJ List<i class="fa-solid fa-caret-down"></i></button>
    </div>
    <!-- Summary -->
    <div id="summary" class="mega-menu">
        <ul>
            <li>Number of PJ</li>
            <li>Number of Units</li>
            <br>
            <li>Average Unit Price</li>
            <li>Highest Price</li>
            <li>Lowest Price</li>
            <li>Middle Price</li>
        </ul>
    </div>

    <!--- Conditions -->
    <div id="conditions" class="mega-menu">
        <!-- radio button -->
        <div id="area-radio" class="area-radio">

            <label for="hn-area" class="a-radio">
                <input type="radio" id="hn-area" name="selector" tabindex="1" checked>
                <span>Hanoi</span>
            </label>
            <label for="hcm-area" class="a-radio">
                <input type="radio" id="hcm-area" name="selector" tabindex="2">
                <span>HCMC</span>
            </label>
            <label for="vn-area" class="a-radio">
                <input type="radio" id="vn-area" name="selector" tabindex="3">
                <span>Vietnam</span>
            </label>
        </div>
        <!-- radio button-->

        <!-- check box -->
        <div id="category-checkbox" class="category-checkbox">
            <label for="primary-category" class="c-checkbox">
                <input type="checkbox" id="primary-category" name="selector" tabindex="1" checked>
                <span>Primary</span>
            </label>
            <label for="hc-category" class="c-checkbox">
                <input type="checkbox" id="hc-category" name="selector" tabindex="2" checked>
                <span>Haseko</span>
            </label>
            <label for="condo-category" class="c-checkbox">
                <input type="checkbox" id="condo-category" name="selector" tabindex="3" checked>
                <span>Condo</span>
            </label>
            <label for="ecoba-category" class="c-checkbox">
                <input type="checkbox" id="ecoba-category" name="selector" tabindex="4" checked>
                <span>Ecoba</span>
            </label>
        </div>
        <!-- check box -->
    </div>

    <!-- PJ List -->
    <div id="listMenu" class="mega-menu"></div>
  
    <div class="menu" id="menu"></div> <!-- Project Listをクリックした際に開くメニュー -->
    
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        
        
        function toggleMenu(menuId, button) {
            const menu = document.getElementById(menuId);

            if (menu.style.display === 'block') {
                // メニューを閉じる
                menu.style.transform = 'translateY(-20px)';
                menu.style.opacity = '0'; // フェードアウト効果
                setTimeout(() => {
                    menu.style.display = 'none';             
                    menu.style.top = "60px"; // 初期位置にリセット（menu-container の下）
                    adjustMenuHeight(); // メニュー高さを再計算
                    adjustMenuPositions(); // メニュー位置の再調整
                }, 500);
            } else {
                // メニューを開く
                menu.style.display = 'block';
                setTimeout(() => {
                    menu.style.transform = 'translateY(0)'; // スライドダウン
                    menu.style.opacity = '1'; // フェードイン効果
                    adjustMenuHeight(); // メニュー高さを再計算
                    adjustMenuPositions(); // メニュー位置の再調整
                }, 0);
            }
        }
      
        function adjustMenuHeight() {
              const menu = document.querySelector('.menu');
              const summary = document.getElementById('summary');
              const conditions = document.getElementById('conditions');

              // 各要素の高さを取得
              const vh = window.innerHeight;
              const menuContainerHeight = 30; // .menu-container の高さ
              const bottomMargin = 100; // 下の余白 50px

              let summaryHeight = summary.style.display === 'block' ? summary.getBoundingClientRect().height : 0;
              let conditionsHeight = conditions.style.display === 'block' ? conditions.getBoundingClientRect().height : 0;

              // menuの新しい高さを計算
              let newHeight = vh - menuContainerHeight - bottomMargin;

              if (summaryHeight > 0 && conditionsHeight > 0) {
                  newHeight -= summaryHeight + conditionsHeight;
              } else if (summaryHeight > 0) {
                  newHeight -= summaryHeight;
              } else if (conditionsHeight > 0) {
                  newHeight -= conditionsHeight;
              }

              // 計算された高さを.menuに設定
              menu.style.height = `${newHeight}px`;

              // メニュー位置の再調整
              adjustMenuPositions();
          }

        function adjustMenuPositions() {
            const visibleMenus = Array.from(document.querySelectorAll('.mega-menu'))
                .filter(menu => menu.style.display === 'block');

            let offsetTop = 60; // 初期のmenu-containerの高さ分を加算

            visibleMenus.forEach(menu => {
                // アニメーションを適用して位置を変更
                menu.style.top = `${offsetTop}px`;
                offsetTop += menu.getBoundingClientRect().height + 10; // メニュー間の余白を加算
            });
        }


        // ウィンドウのサイズが変更された時にメニューの高さを調整
        window.addEventListener('resize', adjustMenuHeight);


        // 地図の初期化
        var map = L.map('map', { zoomControl: false }).setView([21.03966820428092, 105.86461819490408], 12);
      
        // Hanoi, HCMC, Vietnam の座標
        const locations = {
            'hn-area': { coords: [21.03966820428092, 105.86461819490408], zoom: 12 }, // Hanoi
            'hcm-area': { coords: [10.787176769219485, 106.69384890636728], zoom: 12 }, // HCMC
            'vn-area': { coords: [15.9265619930092, 105.9142312190458], zoom: 6 } // Vietnam（広域表示）
        };

        // ラジオボタンにイベントリスナーを追加して地図の中心を変更
        document.getElementById('area-radio').addEventListener('change', function(event) {
            if (event.target && event.target.type === 'radio') {
                const selectedLocation = locations[event.target.id];
                if (selectedLocation) {
                    map.setView(selectedLocation.coords, selectedLocation.zoom, {
                        animate: true,
                        duration: 1.5 // アニメーションの持続時間（秒）
                    });
                }
            }
        });
      

        // MapTilerタイルレイヤーの設定
        var mapTilerApiKey = 'Sv80uSRLZxFEwRiW17Cg';
        L.tileLayer(`https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=${mapTilerApiKey}`, {
            attribution: '&copy; <a href="https://www.maptiler.com/copyright/">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);

        // Category 1の値に基づくアイコンURLを定義
        var categoryIcons = {
            "HC PJ": "https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=FF0062", // 新規検討案件のアイコン
            "Urban PJ": "https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=05227AA8", // 麺開発案件のアイコン
            "ECOBA PJ": "https://img.icons8.com/?size=100&id=42P5zkOQICqY&format=png&color=000000", // ECOBAのアイコン
            "Condominium": "https://img.icons8.com/?size=100&id=uRRFz0DH6uYw&format=png&color=000000", // Condominiumのアイコン
            "Other PJ": "https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=8A8A02A8" // 新規検討案件のアイコン
        };

        // ファイルアップロードの処理
        document.getElementById('fileUpload').addEventListener('change', function(evt) {
            var file = evt.target.files[0];
            if (!file) {
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, { type: 'array' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];
                var jsonData = XLSX.utils.sheet_to_json(worksheet);
              
              
                  
                // Add Urban Area　★★★★★★★★★★★ 
              
                // Smart City
                var latlngs = [
                    [21.124233376634358, 105.82248054911679],
                    [21.124153313644403, 105.8057864802081],
                    [21.123532824006688, 105.8057864802081],
                    [21.12331264964024, 105.80582939555234],
                    [21.123132506733658, 105.80585085322446],
                    [21.122772220264036, 105.80582939555234],
                    [21.122271820937623, 105.80587231089658],
                    [21.121871500260884, 105.80604397227353],
                    [21.121491194617175, 105.80617271830624],
                    [21.12117093647665, 105.80610834528989],
                    [21.120770612828576, 105.80595814158505],
                    [21.120150109038796, 105.80574356486386],
                    [21.119309422344163, 105.80548607279843],
                    [21.118748961900756, 105.80540024210995],
                    [21.11838866478324, 105.80540024210995],
                    [21.1179883336263, 105.80550753047055],
                    [21.117447884850776, 105.80572210719174],
                    [21.116767316925287, 105.80606542994565],
                    [21.11626689734123, 105.80632292201108],
                    [21.115686408509095, 105.80643021037167],
                    [21.115206002240765, 105.80632292201108],
                    [21.114805662495563, 105.80621563365048],
                    [21.11464552629503, 105.80595814158505],
                    [21.11440532167015, 105.80544315745419],
                    [21.114245185037536, 105.8051212923724],
                    [21.11394492838555, 105.80458485056943],
                    [21.113844842699866, 105.80194555689877],
                    [21.111182538679635, 105.80203138758725],
                    [21.11088227583046, 105.80252491404599],
                    [21.110942328448903, 105.80479942729062],
                    [21.11106243361288, 105.805228580733],
                    [21.11142274852154, 105.80625854899472],
                    [21.11176304513198, 105.80739580561703],
                    [21.112063306199023, 105.80838285853451],
                    [21.112103340962058, 105.80874763896054],
                    [21.112003254034214, 105.80986343791074],
                    [21.11186313222184, 105.8103784220416],
                    [21.11176304513198, 105.81104360987729],
                    [21.111622923092764, 105.81134401728696],
                    [21.111022398569016, 105.81269585063046],
                    [21.11090229337265, 105.81306063105649],
                    [21.110662082688293, 105.81331812312192],
                    [21.110301765932746, 105.81391893794125],
                    [21.11080220563476, 105.81443392207211],
                    [21.11098236351436, 105.81456266810483],
                    [21.11244363601177, 105.81411205699033],
                    [21.112643809205885, 105.81413351466244],
                    [21.11300412027482, 105.81421934535092],
                    [21.113304378830584, 105.81439100672787],
                    [21.113684705462354, 105.81462704112118],
                    [21.11394492838555, 105.81477724482602],
                    [21.114505406977774, 105.81490599085873],
                    [21.113844842699866, 105.81851087977475],
                    [21.112003254034214, 105.81814609934872],
                    [21.111803079976017, 105.8181246416766],
                    [21.111662957974612, 105.81821047236508],
                    [21.112183410455724, 105.82533441950864],
                    [21.11258375727601, 105.82597814967221],
                    [21.112783930281097, 105.82632147242612],
                    [21.113064172034576, 105.82645021845883],
                    [21.114245185037536, 105.82657896449155],
                    [21.114925764532543, 105.82657896449155],
                    [21.115266053109362, 105.82649313380307],
                    [21.116647216379057, 105.8258494036395],
                    [21.117247718137953, 105.82567774226254],
                    [21.117748134413585, 105.8256348269183],
                    [21.118588829956558, 105.82597814967221],
                    [21.119469553510477, 105.82610689570492],
                    [21.120190141619705, 105.82606398036069],
                    [21.121511210728, 105.82604252268857],
                    [21.122171740869735, 105.82587086131161],
                    [21.123692950613346, 105.82415424754208],
                    [21.124013203307978, 105.82381092478818],
                    [21.124173329395948, 105.82323156764096],
                    [21.124193345144786, 105.82278095652646],
                    [21.124233376634358, 105.82248054911679]
                ];            
              
              
              
                // ポリゴンを追加して色づけ
                var polygon = L.polygon(latlngs, {
                    color: 'none',         // 枠線の色
                    fillColor: 'gold',     // 塗りつぶしの色
                    fillOpacity: 0.5       // 塗りつぶしの透明度
                }).addTo(map);

                // ポリゴンに識別情報を追加（任意のプロパティを追加して識別可能に）
                polygon.siteName = 'smartCity'; // ここでポリゴンに識別名を設定（例：サイト名）

                // Add Urban Area　★★★★★★★★★★★                

              
              
                
                // 以前のマーカーとチェックボックスをリセット
                if (window.categoryMarkers) {
                    Object.keys(window.categoryMarkers).forEach(function(category) {
                        window.categoryMarkers[category].forEach(function(marker) {
                            map.removeLayer(marker);
                        });
                    });
                }
                window.categoryMarkers = {};
                document.getElementById('listMenu').innerHTML = '';

                // jsonDataを使ってカテゴリー別にチェックボックスとマーカーを作成
                jsonData.forEach(function(item, index) {
                    var category = item['Category 1'] ? item['Category 1'].trim() : ''; // カテゴリーの空チェック
                    if (!category || item['Category 1'] === 'n.a.') {
                        return; // カテゴリーが空、または'n.a.'の場合はスキップ
                    }
                    
                  
                    // Dataの読み込み　▼▼▼▼
                  
                    var category2 = item['Category 2'] && item['Category 2'] !== 'n.a.' ? item['Category 2'] : '';
                    var name = item['PJ name'] && item['PJ name'] !== 'n.a.' ? item['PJ name'] : '';
                    var siteName = item['Site name'] && item['Site name'] !== 'n.a.' ? item['Site name'] : '';
                    var city = item['City'] && item['City'] !== 'n.a.' ? item['City'] : '';
                    var county = item['County'] && item['County'] !== 'n.a.' ? item['County'] : '';
                    var address = item['Address'] && item['Address'] !== 'n.a.' ? item['Address'] : '';                   
                    var location = [item['Latitude'], item['Longitude']];
                    var developer = item['Developer'] && item['Developer'] !== 'n.a.' ? item['Developer'] : '';
                    var units = item['Units'] && item['Units'] !== 'n.a.' ? item['Units'] : '';
                    // Unit Priceのフォーマット（$##,### /sqm）
                    var unitPrice = item['Unit Price'] && item['Unit Price'] !== 'n.a.' ? item['Unit Price'] : null;
                    if (unitPrice) {
                        unitPrice = parseFloat(unitPrice).toLocaleString('en-US', {
                            style: 'currency',
                            currency: 'USD',
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }) + ' /sqm';
                    }
                    var scale = item['Scale'] && item['Scale'] !== 'n.a.' ? item['Scale'] : '';
                    // Launchの日付フォーマット（mmmm, yyyy）
                    var launch = item['Launch'] && item['Launch'] !== 'n.a.' ? item['Launch'] : null;
                    if (launch) {
                        var launchDate = XLSX.SSF.parse_date_code(launch);
                        launch = new Date(launchDate.y, launchDate.m - 1).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    } 
                    var lastUpdate = item['Last Update'] && item['Last Update'] !== 'n.a.' ? item['Last Update'] : null;
                    if (lastUpdate) {
                        var lastUpdateDate = XLSX.SSF.parse_date_code(lastUpdate);
                        lastUpdate = new Date(lastUpdateDate.y, lastUpdateDate.m - 1).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    }
                    var architect = item['Architect'] && item['Architect'] !== 'n.a.' ? item['Architect'] : '';
                    var contractor = item['Contractor'] && item['Contractor'] !== 'n.a.' ? item['Contractor'] : '';
                    var sales = item['Sales Company'] && item['Sales Company'] !== 'n.a.' ? item['Sales Company'] : '';
                    var lastUpdate = item['Last Update'] && item['Last Update'] !== 'n.a.' ? item['Last Update'] : '';
                    var description = item['Description'] && item['Description'] !== 'n.a.' ? item['Description'] : '';
                    var googleMap = item['Google Map'] && item['Google Map'] !== 'n.a.' ? item['Google Map'] : '';
                    var link1 = item['Link 1'] && item['Link 1'] !== 'n.a.' ? item['Link 1'] : '';
                    var link2 = item['Link 2'] && item['Link 2'] !== 'n.a.' ? item['Link 2'] : '';
                    var link3 = item['Link 3'] && item['Link 3'] !== 'n.a.' ? item['Link 3'] : '';


                    
                    // Dataの読み込み　▲▲▲▲
                    

                    

                    // ポップアップの内容をフォーマット
                    var popupContent = "<b>" + name + "</b><br>";
                    if (category2) {
                        popupContent += "<br>" + category2 + "<br>";
                    }
                    if (address) {
                        popupContent += "Location: " + address + "<br>";
                    }
                    if (scale) {
                        popupContent += "Scale: " + scale + "<br>";
                    }
                    if (developer) {
                        popupContent += "Developer: " + developer + "<br>";
                    }
                    if (architect) {
                        popupContent += "Architect: " + architect + "<br>";
                    }
                    if (contractor) {
                        popupContent += "Contractor: " + contractor + "<br>";
                    }
                    if (sales) {
                        popupContent += "Sales Company: " + sales + "<br>";
                    }
                    if (unitPrice) {
                        popupContent += "Unit Price: " + unitPrice + "<br>";
                    }
                    if (launch) {
                        popupContent += "Launch: " + launch + "<br>";
                    }
                    if (lastUpdate) {
                        popupContent += "Last Update: " + lastUpdate + "<br>";
                    }                   
                    if (description) {
                        popupContent += "<br>Note:<br>" + description + "<br>";
                    }
                    if (googleMap) {
                    popupContent += `<br><a href="${googleMap}" target="_blank"><img src="https://img.icons8.com/?size=100&id=FZi5imoPwGuZ&format=png&color=000000" alt="Google Map" style="width:20px;height:20px;"></a>`;
                    }
                    if (link1) {
                    popupContent += `　<a href="${link1}" target="_blank"><img src="https://img.icons8.com/?size=100&id=n9d0Hm43JCPK&format=png&color=000000" alt="Link 1" style="width:20px;height:20px;"></a>`;
                    }
                    if (link2) {
                    popupContent += `　<a href="${link2}" target="_blank"><img src="https://img.icons8.com/?size=100&id=n9d0Hm43JCPK&format=png&color=000000" alt="Link 2" style="width:20px;height:20px;"></a>`;
                    }
                    if (link3) {
                    popupContent += `　<a href="${link3}" target="_blank"><img src="https://img.icons8.com/?size=100&id=n9d0Hm43JCPK&format=png&color=000000" alt="Link 3" style="width:20px;height:20px;"></a>`;
                    }

                    

                    // カテゴリー1の値に基づいてアイコンURLを設定
                    var iconUrl = categoryIcons[category] || 'https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=0000008F'; // デフォルトアイコン
                  
                    // アイコンのサイズ調整
                    var iconSize;
                    if (category === "Primary") {
                        iconSize = [20, 20]; // ECOBAのアイコンサイズを小さく
                    } else if (category === "HC PJ") {
                        iconSize = [37, 37]; // Primaryのアイコンサイズを小さく
                    } else if (category === "Urban PJ") {
                        iconSize = [20, 20]; // Primaryのアイコンサイズを小さく
                    } else if (category === "ECOBA PJ") {
                        iconSize = [20, 20]; // Primaryのアイコンサイズを小さく
                    } else if (category === "Condominium") {
                        iconSize = [20, 20]; // Primaryのアイコンサイズを小さく
                    } else if (category === "Other PJ") {
                        iconSize = [20, 20]; // Primaryのアイコンサイズを小さく
                    } else {
                        iconSize = [30, 30]; // それ以外は通常のサイズ
                    }

                    // アイコンを作成
                    var icon = L.icon({
                        iconUrl: iconUrl,
                        iconSize: iconSize,
                        iconAnchor: [12, iconSize[1]], // アイコンアンカーをサイズに合わせて調整
                        popupAnchor: [0, -iconSize[1]]
                    });

                    var marker = L.marker(location, { icon: icon }).bindPopup(popupContent);
                    
                    // カテゴリーのリストに基づいてマーカーを管理
                    if (!window.categoryMarkers[category]) {
                        window.categoryMarkers[category] = [];
                    }
                    window.categoryMarkers[category].push(marker);
                    marker.addTo(map);

                    // カテゴリーごとのチェックボックスの生成（階層を保持）
                    // CategoryContainerを生成するコード
                    var categoryContainer = document.getElementById('categoryContainer' + category);
                    if (!categoryContainer) {
                        categoryContainer = document.createElement('div');
                        categoryContainer.id = 'categoryContainer' + category;
                        categoryContainer.className = 'layer-group';

                        var mainCategoryDiv = document.createElement('div');
                        mainCategoryDiv.className = 'main-category';
                        mainCategoryDiv.style.display = 'flex';
                        mainCategoryDiv.style.alignItems = 'center';

                        var categoryCheckbox = document.createElement('input');
                        categoryCheckbox.type = 'checkbox';
                        categoryCheckbox.id = 'toggle' + category;
                        categoryCheckbox.checked = true;

                        // テキスト部分をspan要素で囲む（ラベルから分離する）
                        var categoryText = document.createElement('span');
                        categoryText.className = 'category-text'; // テキスト部分にクラスを追加
                        categoryText.textContent = ' ' + category;

                        // mainCategoryDivにチェックボックスとテキストを追加
                        mainCategoryDiv.appendChild(categoryCheckbox);
                        mainCategoryDiv.appendChild(categoryText);
                        categoryContainer.appendChild(mainCategoryDiv);
                        document.getElementById('listMenu').appendChild(categoryContainer);

                        // チェックボックスの状態によってマーカーを表示・非表示にするイベントリスナー
                        categoryCheckbox.addEventListener('change', function(e) {
                            if (e.target.checked) {
                                window.categoryMarkers[category].forEach(function(marker) { marker.addTo(map); });
                            } else {
                                window.categoryMarkers[category].forEach(function(marker) { map.removeLayer(marker); });
                            }

                            // 下位のチェックボックスにも同じ状態を適用
                            const subCheckboxes = categoryContainer.querySelectorAll('.individual-icon-container input[type="checkbox"]');
                            subCheckboxes.forEach(subCheckbox => {
                                subCheckbox.checked = e.target.checked;
                                // 下位のチェックボックスの変更に応じてマーカーも更新
                                if (subCheckbox.checked) {
                                    window.categoryMarkers[category].forEach(marker => marker.addTo(map));
                                } else {
                                    window.categoryMarkers[category].forEach(marker => map.removeLayer(marker));
                                }
                            });
                        });

                        // 開閉アイコンの作成
                        var toggleIcon = document.createElement('i');
                        toggleIcon.className = 'fa-solid fa-caret-down toggle-icon'; // クラス名を変更

                        // mainCategoryDivにcategoryTextの右側にアイコンを追加
                        mainCategoryDiv.appendChild(toggleIcon); // categoryTextの右側に追加

                        // 開閉機能の共通関数
                        function toggleIndividualContainers() {
                            const individualContainers = categoryContainer.querySelectorAll('.individual-icon-container');
                            let isOpen = false;

                            individualContainers.forEach(container => {
                                if (container.style.display === 'none' || container.style.display === '') {
                                    container.style.display = 'block'; // 開く
                                    isOpen = true;
                                } else {
                                    container.style.display = 'none'; // 閉じる
                                }
                            });

                            // アイコンの切り替えとスタイルの適用
                            toggleIcon.classList.toggle('fa-caret-down', !isOpen);
                            toggleIcon.classList.toggle('fa-caret-up', isOpen);
                        }

                        // category-textとtoggle-iconにクリックイベントを設定
                        categoryText.addEventListener('click', function(event) {
                            event.stopPropagation();
                            toggleIndividualContainers();
                        });

                        toggleIcon.addEventListener('click', function(event) {
                            event.stopPropagation();
                            toggleIndividualContainers();
                        });

                   }
                  
          
                  

                    // 各アイテムごとのチェックボックスとラベルの生成
                    var individualContainer = document.createElement('div');
                    individualContainer.className = 'individual-icon-container';
                    individualContainer.style.display = 'none'; // 初期状態は非表示に設定

                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = category + index;
                    checkbox.checked = true;
                    checkbox.className = 'individual-icon';
                    checkbox.addEventListener('change', function() {
                        if (checkbox.checked) {
                            polygon.addTo(map); // ポリゴンをマップに追加（表示）
                            marker.addTo(map);
                        } else {
                            map.removeLayer(marker);
                            map.removeLayer(polygon); // ポリゴンをマップから削除（非表示）
                        }
                    });

                    var label = document.createElement('label');
                    label.htmlFor = category + index;
                    label.className = 'individual-icon';
                    label.appendChild(document.createTextNode(' ' + name));

                    // individual-iconクリックイベントをラベルに追加
                    label.addEventListener('click', function(event) {
                        event.preventDefault();  // チェックボックスの操作を防ぐ

                        // 対応するマーカーのカテゴリと名前を取得して特定
                        const marker = window.categoryMarkers[category]?.find(m => m.getPopup().getContent().includes(name));

                        if (marker) {
                            // マーカーの位置に地図を移動、アニメーションの速度を調整
                            map.flyTo(marker.getLatLng(), map.getZoom(), {
                                animate: true,
                                duration: 1.3 // 持続時間を秒単位で設定 (例: 2秒)
                            });
                            
                            // 地図の移動が終わった後にポップアップを開くための遅延を設定
                            setTimeout(() => {
                                marker.openPopup();
                            }, 1300); // flyToのdurationと同じ時間（1.3秒）を遅延させる                          
                        }
                    });

                    individualContainer.appendChild(checkbox);
                    individualContainer.appendChild(label);
                    categoryContainer.appendChild(individualContainer);

                });
            };
            reader.readAsArrayBuffer(file);
        }); 
      
      
      

        // #conditions内のチェックボックスを#PJ List内の関連する親チェックボックスと連動させる
        document.querySelectorAll('#conditions .c-checkbox input[type="checkbox"]').forEach(conditionCheckbox => {
            conditionCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;

                // 各条件のチェックボックスIDに応じた親チェックボックスを探して連動させる
                let parentCheckboxId;
                switch (this.id) {
                    case 'primary-category':
                        parentCheckboxId = 'togglePrimary';
                        break;
                    case 'condo-category':
                        parentCheckboxId = 'toggleCondominium';
                        break;
                    case 'ecoba-category':
                        parentCheckboxId = 'toggleECOBA PJ';
                        break;
                    case 'hc-category':
                        parentCheckboxId = 'toggleHC PJ';
                        break;
                    default:
                        return; // マッチするものがない場合は処理を中断
                }

                // 親チェックボックスを見つけて、その状態を更新
                const parentCheckbox = document.getElementById(parentCheckboxId);
                if (parentCheckbox) {
                    parentCheckbox.checked = isChecked;

                    // 親チェックボックスの変更に応じて、その下層のチェックボックスも連動させる
                    const individualCheckboxes = parentCheckbox.closest('.layer-group').querySelectorAll('.individual-icon-container input[type="checkbox"]');
                    individualCheckboxes.forEach(individualCheckbox => {
                        individualCheckbox.checked = isChecked;

                        // マーカーの表示・非表示を同期
                        const category = individualCheckbox.dataset.category || parentCheckboxId.replace('toggle', '').trim();
                        const name = individualCheckbox.labels[0]?.textContent.trim(); // ラベルからプロジェクト名を取得
                        const marker = window.categoryMarkers[category]?.find(m => m.getPopup().getContent().includes(name));

                        if (marker) {
                            if (isChecked) {
                                marker.addTo(map);
                            } else {
                                map.removeLayer(marker);
                            }
                        }
                    });
                }
            });
        });

      
        // 画面ローテーションでリロード
        function handleOrientationChange() {
          if (window.matchMedia("(orientation: portait)").matches) {
            document.body.style.width = "100%";
          } else if (window.matchMedia("(orientation: landscape)").matches) {
            document.body.style.width = "100vw";
          }
        }

        window.addEventListener("orientationchange", handleOrientationChange);
        window.addEventListener("resize", handleOrientationChange);
        handleOrientationChange(); 
    </script>
</body>
</html>
