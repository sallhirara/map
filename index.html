<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mapping system</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
        }

        .menu-container {
            color: #333;
            display: flex;
            height: 30px;
            width: 90%;
            justify-content: flex-start;
            margin: 5px 20px;
            position: relative;
        }

        .custom-file-upload {
            color: #333;
            font-size: 20px;
            margin-right: 10px;
            display: inline-block;
            padding: 4px 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .custom-file-upload:hover {
            background-color: #ddd;
        }

        #fileUpload {
            display: none;
        }
        
        .menu-button,
        .save-button,

        .reset-button {
            margin: 0 5px;
            padding: 5px 10px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: transparent;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #333;
        }

        .menu-button i {
            margin-left: 10px;
        }

        .save-button {
            margin-left: 30px;
        }

        .menu-button:hover,
        .save-button:hover,

        .reset-button:hover {
            background-color: #ddd;
        }

        .mega-menu {
            display: none;
            position: absolute;
            width: 90%;
            max-width: 500px;
            overflow-y: hidden;
            left: 5%;
            background: rgba(255, 255, 255, 0.3); /* 半透明 */
            backdrop-filter: blur(5px);

            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            font-size: 12px;

            top: 60px; /* menu-container (30px) + margin (10px) を考慮 */
            transform: translateY(-20px); /* 初期状態で少し上に隠しておく */
            opacity: 0; /* 初期は非表示 */
            transition: transform 0.7s ease, opacity 0.7s ease, top 0.7s ease; /* アニメーションをゆっくりに変更 */
        }
      
        .mega-menu::-webkit-scrollbar {
          display: none; /* Chrome, Safari, Opera のスクロールバーを非表示 */
        }
        
        .mega-menu::before {
            content: "";
            position: absolute;
            top: -20px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-width: 10px;
            border-style: solid;
            border-color: transparent transparent #ffffff transparent;
        }


        /* -------- Summary from here --------*/
        #summary {
            border: none;
            padding: 20px;
            font-size: 12px;
        }
        /* -------- Summary to here --------*/


        /* -------- Conditions from here --------*/
        #conditions {
            border: none;
            font-size: 12px;
        }

        /* radio */
        .area-radio,
        .scale-radio {
            border: none;
            margin-bottom: 5px;
          
            /*　radio items の割り付けグリッド４分割　*/
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 横に2分割 */
            grid-template-rows: repeat(1, 1fr);    /* 縦に2分割 */
            gap: 0px;                             /* 各アイテム間のスペース */             
        }

        .a-radio,
        .sc-radio {
          border: none;
            padding: 6px;
            border-radius: 50px;
            display: inline-flex;
            cursor: pointer;
            transition: background 0.2s ease;
            margin: 0px;
            -webkit-tap-highlight-color: transparent;
        }

        .a-radio:hover,
        .sc-radio:hover,
        .a-radio:focus-within,
        .sc-radio:focus-within {
            background: rgba(159, 159, 159, 0.3); /* $secondary color in RGBA */
        }

        .a-radio input,
        .sc-radio input {
            vertical-align: middle;
            width: 16px;
            height: 16px;
            border-radius: 10px;
            background: none;
            border: 0;
            box-shadow: inset 0 0 0 1.5px #9F9F9F; /* $secondary color */
            appearance: none;
            padding: 0;
            margin: 0;
            transition: box-shadow 150ms cubic-bezier(0.95, 0.15, 0.5, 1.25);
            pointer-events: none;
        }

        .a-radio input:focus,
        .sc-radio input:focus {
            outline: none;
        }

        .a-radio input:checked,
        .sc-radio input:checked {
            box-shadow: inset 0 0 0 5px #00258F85; /* $primary color */
        }

        .a-radio span,
        .sc-radio span {
            vertical-align: middle;
            display: inline-block;
            line-height: 16px;
            padding: 0 8px;
        }
        /* radio */

        /* checkbox */
        .category-checkbox {
            border: none;
            margin-bottom: 5px;
            
            /*　checkbox　item の均等割り付け　*/
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 横に2分割 */
            grid-template-rows: repeat(1, 1fr);    /* 縦に2分割 */
            gap: 0px;                             /* 各アイテム間のスペース */
     
        }

        .c-checkbox {
          border: none!important;
            padding: 6px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2 ease;
            margin: 0px;
            -webkit-tap-highlight-color: transparent;
        }

        .c-checkbox:hover,
        .c-checkbox:focus-within {
            background: rgba(159, 159, 159, 0.3); /* $secondary color in RGBA */
            border-radius: 10px !important;
        }

        .c-checkbox input {
            vertical-align: middle !important;
            width: 16px !important;
            height: 16px !important;
            border-radius: 6px !important;
            background: none !important;
            border: 0 !important;
            box-shadow: inset 0 0 0 1.5px #9F9F9F !important; /* $secondary color */
            appearance: none !important;
            padding: 0 !important;
            margin: 0 !important;
            transition: box-shadow 150ms cubic-bezier(0.95, 0.15, 0.5, 1.25) !important;
            pointer-events: none !important;
        }

        .c-checkbox input:focus {
            outline: none !important;
        }

        .c-checkbox input:checked {
            box-shadow: inset 0 0 0 10px #00258F85 !important; /* $primary color */
        }

        .c-checkbox input[type="checkbox"]:checked::before {
            color: lightgray !important;
        }        

        .c-checkbox span {
            vertical-align: middle;
            display: inline-block;
            line-height: 16px;
            padding: 0 8px;
        }
        /* checkbox */
        
        /* area list */
      
        #area-list-container {
            max-height: 121px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 0 6px;
            -ms-overflow-style: none;  /* IEとEdgeでスクロールバーを非表示 */
            scrollbar-width: none;  /* Firefoxでスクロールバーを非表示 */          
        }
      
    .region-layer span,
    .admin-layer span,
    .local-layer span {
        padding-left: 10px;
    }
      
      
    .layer-group {
        margin: 0; /* Countryレイヤーのインデント */
    }
    .region-layer {
        margin: 0 0 10px 10px; /* Regionレイヤーのインデント */
    }
    .admin-layer {
        margin: 5px 0 10px 15px; /* Administrative Divisionレイヤーのインデント */
    }
    .local-layer {
        margin: 5px 0 10px 20px; /* Local Divisionレイヤーのインデント */
    }

      
        /* aria list */
      
        /* -------- Conditions to here --------*/


        /* -------- PJ List from here --------*/
        #listMenu {
            overflow-y: auto;
            margin: 0;
            padding: 20px 25px;
            -ms-overflow-style: none;  /* IEとEdgeでスクロールバーを非表示 */
            scrollbar-width: none;  /* Firefoxでスクロールバーを非表示 */
        }
        
        #listMenu::-webkit-scrollbar {
          display: none;
        }
        

        /*Category 1 毎 のコンテナ*/
        .layer-group {
            margin-bottom: 15px;
        }
        
        /*Category 1 のヘッダーコンテナ*/
        .main-category {
            margin-bottom: 10px;
        }

        /*Category 1 のテキスト部分*/
        .category-text {
            padding-left: 10px;
            font-size: 14px;
            font-weight: bolder;
            color: #555;
            cursor: pointer;
        }

        /* アイコンの共通スタイル */
        .toggle-icon {
            height: 18px;
            padding: 2px 5px 2px 17px;
            color: #999; /* 開いた状態で色を変更 */
        }

        /* 開いているときのスタイル */
        .toggle-icon.open {
            color: #999; /* 開いた状態で色を変更 */
        }

        /*PJ Name それぞれのコンテナ*/
        .individual-icon-container {
            margin-bottom: 5px;
        }

        .individual-icon {
            margin-left: 10px;
            cursor: alias;
        }

        input[type="checkbox"] {
            vertical-align: middle;
            appearance: none;
            width: 16px;
            height: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            display: inline-block;
        }

        input[type="checkbox"]:checked {
            font-size: 9px;
            background-color: #9F220585;
            border: none;
            position: relative;
        }

        input[type="checkbox"]:checked::before {
            content: '\2714';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
        }

        /* -------- PJ List to here --------*/

        #map {
            position: absolute;
            height: calc(100% - 40px); /* menu-container の高さ +margin を考慮 */
            width: 100%;
            top: 40px; /* menu-container の高さ分だけ下にずらす */
        }



        .leaflet-popup-content {
            user-select: text;
        }

/* ポリゴンのポップアップのデザイン */
.polygon-popup {
    color: #333; /* テキストカラー */
    font-family: Arial, sans-serif; /* フォント */
    font-size: 14px; /* フォントサイズ */
    border-radius: 10px; /* 角を丸くする */
    padding: 10px; /* 内側の余白 */
    line-height: 1.4; /* 行間 */
}

/* ポリゴンのポップアップ内のリンク */
.polygon-popup a {
    color: #00258f; /* 青いリンク */
    text-decoration: underline;
    font-weight: bold;
}

/* ポリゴンのポップアップ内のリンクにホバー時のスタイル */
.polygon-popup a:hover {
    color: none; /* オレンジ色に変更 */
    text-decoration: none;
}        

    </style>
</head>
<body>
    <div class="menu-container">
        <label for="fileUpload" class="custom-file-upload"><i class="fa-solid fa-file-arrow-down"></i></label>
        <input type="file" id="fileUpload" accept=".xlsx,.xlsm" />
        <button class="menu-button" onclick="toggleMenu('summary', this)">SUM.<i class="fa-solid fa-caret-down"></i></button>
        <button class="menu-button" onclick="toggleMenu('conditions', this)">COND.<i class="fa-solid fa-caret-down"></i></button>
        <button class="menu-button" onclick="toggleMenu('listMenu', this)">LIST<i class="fa-solid fa-caret-down"></i></button>

        <button class="save-button" type="button" date-action=""><i class="fa fa-save"></i></button>
        <button class="reset-button" type="button" date-action=""><i class="fa-solid fa-arrows-rotate"></i></button>
    </div>
    <!-- Summary -->
    <div id="summary" class="mega-menu">
        <ul>
            <li>Number of PJ</li>
            <li>Number of Units</li>
            <br>
            <li>Average Unit Price</li>
            <li>Highest Price</li>
            <li>Lowest Price</li>
            <li>Middle Price</li>
        </ul>
    </div>

    <!--- Conditions -->
    <div id="conditions" class="mega-menu">
        <!-- radio button for center -->
        <div id="area-radio" class="area-radio">

            <label for="hn-area" class="a-radio">
                <input type="radio" id="hn-area" name="selector1" tabindex="1" checked>
                <span>Hanoi</span>
            </label>
            <label for="hcm-area" class="a-radio">
                <input type="radio" id="hcm-area" name="selector1" tabindex="2">
                <span>HCMC</span>
            </label>
            <label for="vn-area" class="a-radio">
                <input type="radio" id="vn-area" name="selector1" tabindex="3">
                <span>Vietnam</span>
            </label>
        </div>
        <!-- radio butto- for center->

        <!-- radio button for scale -->
        <div id="scale-radio" class="scale-radio">

            <label for="sc-50000" class="sc-radio">
                <input type="radio" id="sc-50000" name="selector2" tabindex="1">
                <span>1/50,000</span>
            </label>   
            <label for="sc-10000" class="sc-radio">
                <input type="radio" id="sc-10000" name="selector2" tabindex="2">
                <span>1/10,000</span>
            </label> 
            <label for="sc-2000" class="sc-radio">
                <input type="radio" id="sc-2000" name="selector2" tabindex="3">
                <span>1/2,000</span>
            </label>          
            <label for="sc-1000" class="sc-radio">
                <input type="radio" id="sc-1000" name="selector2" tabindex="4">
                <span>1/1000</span>
            </label>


       
        </div>
        <!-- radio button for scale-->
        
        <br>
      
        <!-- check box -->
        <div id="category-checkbox" class="category-checkbox">
            <label for="primary-category" class="c-checkbox">
                <input type="checkbox" id="primary-category" name="selector" tabindex="1" checked>
                <span>Primary</span>
            </label>
            <label for="hc-category" class="c-checkbox">
                <input type="checkbox" id="hc-category" name="selector" tabindex="2" checked>
                <span>Haseko</span>
            </label>
            <label for="condo-category" class="c-checkbox">
                <input type="checkbox" id="condo-category" name="selector" tabindex="3" checked>
                <span>Condo</span>
            </label>
            <label for="ecoba-category" class="c-checkbox">
                <input type="checkbox" id="ecoba-category" name="selector" tabindex="4" checked>
                <span>Ecoba</span>
            </label>
            <label for="site-category" class="c-checkbox">
                <input type="checkbox" id="site-category" name="selector" tabindex="" checked>
                <span>PJ Site</span>
            </label>
        </div>
        <!-- check box -->
      
        <!-- Area list container-->
        <div id="area-list-container" class="area-list-container">
        </div>
        <!-- Area List -->
      
    </div>

    <!-- PJ List -->
    <div id="listMenu" class="mega-menu"></div>
  
    <div class="menu" id="menu"></div> <!-- Project Listをクリックした際に開くメニュー -->
    
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        
        
        function toggleMenu(menuId, button) {
            const menu = document.getElementById(menuId);

            if (menu.style.display === 'block') {
                menu.style.transform = 'translateY(-20px)';
                menu.style.opacity = '0'; // フェードアウト効果
                document.body.style.overflow = ''; // スクロールを有効化                
                setTimeout(() => {
                    menu.style.display = 'none';             
                    menu.style.top = "60px"; // 初期位置にリセット（menu-container の下）
                    adjustMenuHeight(); // メニュー高さを再計算
                    adjustMenuPositions(); // メニュー位置の再調整
                }, 500);
            } else {
                menu.style.display = 'block';
                setTimeout(() => {
                    menu.style.transform = 'translateY(0)'; // スライドダウン
                    menu.style.opacity = '1'; // フェードイン効果
                    document.body.style.overflow = 'hidden'; // スクロールを無効化
                    adjustMenuHeight(); // メニュー高さを再計算
                    adjustMenuPositions(); // メニュー位置の再調整
                }, 0);
            }
        }
      
        function adjustMenuHeight() {
            const menu = document.querySelector('.menu');
            const listMenu = document.getElementById('listMenu');
            const summary = document.getElementById('summary');
            const conditions = document.getElementById('conditions');
            const areaListContainer = document.getElementById('area-list-container');

            const vh = window.innerHeight; // ビューポート全体の高さ
            const menuContainerHeight = 30; // メニューコンテナの高さ
            const bottomMargin = 100; // 余白として 100px を引く

            // summary と conditions の高さを取得
            const summaryHeight = summary.style.display === 'block' ? summary.getBoundingClientRect().height : 0;
            const conditionsHeight = conditions.style.display === 'block' ? conditions.getBoundingClientRect().height : 0;

            // max-height の計算
            let newMaxHeight = vh - summaryHeight - conditionsHeight - bottomMargin;

            // 設定
            listMenu.style.maxHeight = `${newMaxHeight}px`;

            // menu の通常の高さを設定（省略せずに記述）
            let newHeight = vh - menuContainerHeight - bottomMargin;
            if (summaryHeight > 0) {
                newHeight -= summaryHeight;
            }
            if (conditionsHeight > 0) {
                newHeight -= conditionsHeight;
            }
            menu.style.height = `${newHeight}px`;

            adjustMenuPositions();
        }

        // ResizeObserverを使用してarea-list-containerの高さの変化を監視
        const areaListObserver = new ResizeObserver(() => {
            adjustMenuHeight(); // 高さの変化に応じてメニューの高さを再計算
        });

        const areaListContainer = document.getElementById('area-list-container');
        areaListObserver.observe(areaListContainer);


        
        function adjustMenuPositions() {
            const visibleMenus = Array.from(document.querySelectorAll('.mega-menu'))
                .filter(menu => menu.style.display === 'block');

            let offsetTop = 60; // 初期のmenu-containerの高さ分を加算

            visibleMenus.forEach(menu => {
                // アニメーションを適用して位置を変更
                menu.style.top = `${offsetTop}px`;
                offsetTop += menu.getBoundingClientRect().height + 10; // メニュー間の余白を加算
            });
        }


        // ウィンドウのサイズが変更された時にメニューの高さを調整
        window.addEventListener('resize', adjustMenuHeight);


        // 地図の初期化
        var map = L.map('map', { zoomControl: false }).setView([21.03966820428092, 105.86461819490408], 12);
      
        // Hanoi, HCMC, Vietnam の座標
        const locations = {
            'hn-area': { coords: [21.03966820428092, 105.86461819490408], zoom: 12 }, // Hanoi
            'hcm-area': { coords: [10.787176769219485, 106.69384890636728], zoom: 12 }, // HCMC
            'vn-area': { coords: [15.9265619930092, 105.9142312190458], zoom: 6 } // Vietnam（広域表示）
        };

        // ラジオボタンにイベントリスナーを追加して地図の中心を変更
        document.getElementById('area-radio').addEventListener('change', function(event) {
            if (event.target && event.target.type === 'radio') {
                const selectedLocation = locations[event.target.id];
                if (selectedLocation) {
                    map.setView(selectedLocation.coords, selectedLocation.zoom, {
                        animate: true,
                        duration: 1.5 // アニメーションの持続時間（秒）
                    });
                }
            }
        });
      
        
        // 各縮尺に対応するズームレベルの定義
        // これは概算であり、地図の中心位置やデバイスによって異なる場合があります
        document.querySelectorAll('#conditions .sc-radio input[type="radio"]').forEach(function(radio) {
            radio.addEventListener('change', function(event) {
                if (event.target && event.target.id.startsWith('sc-')) {
                    let zoomLevel;
                    switch (event.target.id) {
                        case 'sc-1000':
                            zoomLevel = 18;
                            break;
                        case 'sc-2000':
                            zoomLevel = 17;
                            break;
                        case 'sc-10000':
                            zoomLevel = 15;
                            break;
                        case 'sc-50000':
                            zoomLevel = 12;
                            break;                
                        default:
                            zoomLevel = 12; // デフォルトのズームレベル
                    }
                    map.setZoom(zoomLevel, {
                        animate: true,
                        duration: 1.5
                    });
                }
            });
        });
      

        // MapTilerタイルレイヤーの設定
        var mapTilerApiKey = 'Sv80uSRLZxFEwRiW17Cg';
        L.tileLayer(`https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=${mapTilerApiKey}`, {
            attribution: '&copy; <a href="https://www.maptiler.com/copyright/">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);

        // Category 1の値に基づくアイコンURLを定義
        var categoryIcons = {
            "HC PJ": "https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=FF0062", // 新規検討案件のアイコン
            "PJ Site": "https://img.icons8.com/?size=100&id=ipgAkdE46kxu&format=png&color=000000", // サイトのアイコン          
            "Urban PJ": "https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=05227AA8", // 麺開発案件のアイコン
            "ECOBA PJ": "https://img.icons8.com/?size=100&id=42P5zkOQICqY&format=png&color=000000", // ECOBAのアイコン
            "Condominium": "https://img.icons8.com/?size=100&id=uRRFz0DH6uYw&format=png&color=000000", // Condominiumのアイコン
            "Other PJ": "https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=8A8A02A8" // 新規検討案件のアイコン
        };

        
        // 円を追加
        var centerCircle = L.circle(map.getCenter(), {
            color: 'blue',         // 枠線の色
            weight: 0.5,             // 枠線の太さ
            opacity: 0.5,          // 枠線の透明度
            fillColor: 'none',     // 塗りつぶしの色
            fillOpacity: 0.1,      // 塗りつぶしの透明度
            radius: 5000           // 半径 5000m（5km）
        }).addTo(map);

        // イージング関数 (easeInOutQuad)
        function easeInOutQuad(t) {
            return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
        }

        // 円の中心を滑らかに移動させる関数
        function smoothlyMoveCircle(circle, newLatLng, duration = 1000) {
            var startLatLng = circle.getLatLng();
            var startTime = performance.now();

            function animateMove() {
                var currentTime = performance.now();
                var elapsed = currentTime - startTime;
                var progress = Math.min(elapsed / duration, 1);

                // イージングを適用
                var easedProgress = easeInOutQuad(progress);

                // 線形補間にイージングを適用して位置を計算
                var interpolatedLat = startLatLng.lat + easedProgress * (newLatLng.lat - startLatLng.lat);
                var interpolatedLng = startLatLng.lng + easedProgress * (newLatLng.lng - startLatLng.lng);

                circle.setLatLng([interpolatedLat, interpolatedLng]);

                if (progress < 1) {
                    requestAnimationFrame(animateMove);
                }
            }

            requestAnimationFrame(animateMove);
        }

        // 地図の移動にアニメーション付きで円を追従させる
        map.on('moveend', function () {
            smoothlyMoveCircle(centerCircle, map.getCenter());
        });

        // ズーム時にも対応（必要に応じて）
        map.on('zoomend', function () {
            smoothlyMoveCircle(centerCircle, map.getCenter());
        });




        // ファイルアップロードの処理
        document.getElementById('fileUpload').addEventListener('change', function(evt) {
            var file = evt.target.files[0];
            if (!file) {
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, { type: 'array' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];
                var jsonData = XLSX.utils.sheet_to_json(worksheet);         
              
                
                // 以前のマーカーとチェックボックスをリセット
                if (window.categoryMarkers) {
                    Object.keys(window.categoryMarkers).forEach(function(category) {
                        window.categoryMarkers[category].forEach(function(marker) {
                            map.removeLayer(marker);
                        });
                    });
                }
                window.categoryMarkers = {};
                document.getElementById('listMenu').innerHTML = '';

                // jsonDataを使ってカテゴリー別にチェックボックスとマーカーを作成
                jsonData.forEach(function(item, index) {
                    var category = item['Category 1'] ? item['Category 1'].trim() : ''; // カテゴリーの空チェック
                    if (!category || item['Category 1'] === 'n.a.') {
                        return; // カテゴリーが空、または'n.a.'の場合はスキップ
                    }
                    
                  
                    // Dataの読み込み　▼▼▼▼
                  
                    var category2 = item['Category 2'] && item['Category 2'] !== 'n.a.' ? item['Category 2'] : '';
                    var name = item['PJ name'] && item['PJ name'] !== 'n.a.' ? item['PJ name'] : '';
                    var siteName = item['Site name'] && item['Site name'] !== 'n.a.' ? item['Site name'] : '';
                    var country = item['Country'] && item['Country'] !== 'n.a.' ? item['Country'] : '';
                    var region = item['Region'] && item['Region'] !== 'n.a.' ? item['Region'] : '';
                    var adminDivision = item['Administrative Division'] && item['Administrative Division'] !== 'n.a.' ? item['Administrative Division'] : '';
                    var localDivision = item['Local Division'] && item['Local Division'] !== 'n.a.' ? item['Local Division'] : '';
                    var address = item['Address'] && item['Address'] !== 'n.a.' ? item['Address'] : '';                 
                    var location = [item['Latitude'], item['Longitude']];

                    var coordinates = item['Site Area'] && item['Site Area'] !== 'n.a.' ? item['Site Area'] : null;
                    
                    var developer = item['Developer'] && item['Developer'] !== 'n.a.' ? item['Developer'] : '';
                    var units = item['Units'] && item['Units'] !== 'n.a.' ? item['Units'] : '';
                    // Unit Priceのフォーマット（$##,### /sqm）
                    var unitPrice = item['Unit Price'] && item['Unit Price'] !== 'n.a.' ? item['Unit Price'] : null;
                    if (unitPrice) {
                        unitPrice = parseFloat(unitPrice).toLocaleString('en-US', {
                            style: 'currency',
                            currency: 'USD',
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }) + ' /sqm';
                    }
                    var scale = item['Scale'] && item['Scale'] !== 'n.a.' ? item['Scale'] : '';
                    // Launchの日付フォーマット（mmmm, yyyy）
                    var launch = item['Launch'] && item['Launch'] !== 'n.a.' ? item['Launch'] : null;
                    if (launch) {
                        var launchDate = XLSX.SSF.parse_date_code(launch);
                        launch = new Date(launchDate.y, launchDate.m - 1).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    } 
                    var lastUpdate = item['Last Update'] && item['Last Update'] !== 'n.a.' ? item['Last Update'] : null;
                    if (lastUpdate) {
                        var lastUpdateDate = XLSX.SSF.parse_date_code(lastUpdate);
                        lastUpdate = new Date(lastUpdateDate.y, lastUpdateDate.m - 1).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    }
                    var architect = item['Architect'] && item['Architect'] !== 'n.a.' ? item['Architect'] : '';
                    var contractor = item['Contractor'] && item['Contractor'] !== 'n.a.' ? item['Contractor'] : '';
                    var sales = item['Sales Company'] && item['Sales Company'] !== 'n.a.' ? item['Sales Company'] : '';
                    var lastUpdate = item['Last Update'] && item['Last Update'] !== 'n.a.' ? item['Last Update'] : '';
                    var description = item['Description'] && item['Description'] !== 'n.a.' ? item['Description'] : '';
                    var googleMap = item['Google Map'] && item['Google Map'] !== 'n.a.' ? item['Google Map'] : '';
                    var link1 = item['Link 1'] && item['Link 1'] !== 'n.a.' ? item['Link 1'] : '';
                    var link2 = item['Link 2'] && item['Link 2'] !== 'n.a.' ? item['Link 2'] : '';
                    var link3 = item['Link 3'] && item['Link 3'] !== 'n.a.' ? item['Link 3'] : '';

                    console.log(parsedCoordinates); // 座標が正しいか確認
                    
                    // Dataの読み込み　▲▲▲▲
                    

                    

                    // ポップアップの内容をフォーマット
                    var popupContent = "<b>" + name + "</b><br>";
                    if (category2) {
                        popupContent += "<br>" + category2 + "<br>";
                    }
                    if (address) {
                        popupContent += "Location: " + address + "<br>";
                    }
                    if (scale) {
                        popupContent += "Scale: " + scale + "<br>";
                    }
                    if (developer) {
                        popupContent += "Developer: " + developer + "<br>";
                    }
                    if (architect) {
                        popupContent += "Architect: " + architect + "<br>";
                    }
                    if (contractor) {
                        popupContent += "Contractor: " + contractor + "<br>";
                    }
                    if (sales) {
                        popupContent += "Sales Company: " + sales + "<br>";
                    }
                    if (unitPrice) {
                        popupContent += "Unit Price: " + unitPrice + "<br>";
                    }
                    if (launch) {
                        popupContent += "Launch: " + launch + "<br>";
                    }
                    if (lastUpdate) {
                        popupContent += "Last Update: " + lastUpdate + "<br>";
                    }                   
                    if (description) {
                        popupContent += "<br>Note:<br>" + description + "<br>";
                    }
                    if (googleMap) {
                    popupContent += `<br><a href="${googleMap}" target="_blank"><img src="https://img.icons8.com/?size=100&id=FZi5imoPwGuZ&format=png&color=000000" alt="Google Map" style="width:20px;height:20px;"></a>`;
                    }
                    if (link1) {
                    popupContent += `　<a href="${link1}" target="_blank"><img src="https://img.icons8.com/?size=100&id=n9d0Hm43JCPK&format=png&color=000000" alt="Link 1" style="width:20px;height:20px;"></a>`;
                    }
                    if (link2) {
                    popupContent += `　<a href="${link2}" target="_blank"><img src="https://img.icons8.com/?size=100&id=n9d0Hm43JCPK&format=png&color=000000" alt="Link 2" style="width:20px;height:20px;"></a>`;
                    }
                    if (link3) {
                    popupContent += `　<a href="${link3}" target="_blank"><img src="https://img.icons8.com/?size=100&id=n9d0Hm43JCPK&format=png&color=000000" alt="Link 3" style="width:20px;height:20px;"></a>`;
                    }

                    

                    // カテゴリー1の値に基づいてアイコンURLを設定
                    var iconUrl = categoryIcons[category] || 'https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=571601B8'; // デフォルトアイコン
                  
                    // アイコンのサイズ調整
                    var iconSize;
                    if (category === "Primary") {
                        iconSize = [20, 20]; // ECOBAのアイコンサイズを小さく
                    } else if (category === "PJ Site") {
                        iconSize = [0, 0]; // Other PJのアイコンサイズを小さく
                    } else if (category === "HC PJ") {
                        iconSize = [37, 37]; // HC PJのアイコンサイズを小さく
                    } else if (category === "Urban PJ") {
                        iconSize = [0, 0]; // Urban PJのアイコン
                    } else if (category === "ECOBA PJ") {
                        iconSize = [20, 20]; // ECIOBA PJのアイコンサイズを小さく
                    } else if (category === "Condominium") {
                        iconSize = [20, 20]; // Condominiumのアイコンサイズを小さく
                    } else if (category === "Other PJ") {
                        iconSize = [20, 20]; // Other PJのアイコンサイズを小さく
                    } else {
                        iconSize = [30, 30]; // それ以外は通常のサイズ
                    }

                    // アイコンを作成
                    var icon = L.icon({
                        iconUrl: iconUrl,
                        iconSize: iconSize,
                        iconAnchor: [12, iconSize[1]], // アイコンアンカーをサイズに合わせて調整
                        popupAnchor: [0, -iconSize[1]]
                    });

                    var marker = L.marker(location, { icon: icon }).bindPopup(popupContent);

                    //　ポップアップ生成
                    if (name && coordinates) {
                        try {
                            // JSON.parseでエラーが出た場合のフォールバック
                            var parsedCoordinates = typeof coordinates === "string" ? JSON.parse(coordinates) : coordinates;

                            // カテゴリー1の値に基づいて色を決定
                            var fillColor;
                            switch (category) {
                                case 'PJ Site':
                                    fillColor = '#FF0062A8'; // カテゴリーがPrimaryの場合の色
                                    break;
                                case 'HC PJ':
                                    fillColor = 'red'; // カテゴリーがHC PJの場合の色
                                    break;
                                case 'Urban PJ':
                                    fillColor = 'gold'; // カテゴリーがUrban PJの場合の色
                                    break;
                                default:
                                    fillColor = 'grey'; // その他の場合の色
                            }

                            // ポリゴンを追加
                            var polygon = L.polygon(parsedCoordinates, {
                                color: 'none',
                                weight: 0,
                                opacity: 0.8,
                                fillColor: fillColor,  // カテゴリーに応じた塗りつぶしの色
                                fillOpacity: 0.3
                            }).bindPopup(popupContent, {
                                className: 'polygon-popup' // カスタムクラスを割り当てる
                            });


                            polygon.addTo(map);
                        } catch (error) {
                            console.error(`Error parsing coordinates for ${name}:`, error);
                        }
                    }

                    // カテゴリーのリストに基づいてマーカーを管理
                    if (!window.categoryMarkers[category]) {
                        window.categoryMarkers[category] = [];
                    }
                    window.categoryMarkers[category].push(marker);
                    marker.addTo(map);

       
                  
                  
                  
// エリアリストコンテナをクリア
const areaListContainer = document.getElementById('area-list-container');
areaListContainer.innerHTML = ''; // 既存のコンテンツをクリア

// 階層構造を構築
const hierarchy = {};
jsonData.forEach(item => {
    const country = item['Country'];
    const region = item['Region'];
    const adminDivision = item['Administrative Division'];
    const localDivision = item['Local Division'];

    if (!country) return;

    if (!hierarchy[country]) hierarchy[country] = {};
    if (region) {
        if (!hierarchy[country][region]) hierarchy[country][region] = {};
        if (adminDivision) {
            if (!hierarchy[country][region][adminDivision]) hierarchy[country][region][adminDivision] = [];
            if (localDivision) {
                hierarchy[country][region][adminDivision].push(localDivision);
            }
        }
    }
});

// 子チェックボックスの状態を親に反映する
function updateParentCheckbox(parentCheckbox, childCheckboxes) {
    const allChecked = Array.from(childCheckboxes).every(cb => cb.checked);
    const noneChecked = Array.from(childCheckboxes).every(cb => !cb.checked);

    parentCheckbox.checked = allChecked;
    parentCheckbox.indeterminate = !allChecked && !noneChecked; // 子の状態が混在している場合
}

// 親チェックボックスの状態を子に反映する
function updateChildCheckboxes(parentCheckbox, childCheckboxes) {
    childCheckboxes.forEach(cb => {
        cb.checked = parentCheckbox.checked;
        cb.dispatchEvent(new Event('change')); // マーカー連動のためにイベントを発火
    });
}

// 階層データを使ってチェックボックスリストを生成
Object.keys(hierarchy).forEach(country => {
    const countryContainer = document.createElement('div');
    countryContainer.className = 'layer-group';

    const countryHeader = document.createElement('div');
    countryHeader.className = 'main-category';
    countryHeader.innerHTML = `
        <input type="checkbox" id="country-${country}" checked>
        <span class="category-text">${country}</span>
        <i class="fa-solid fa-caret-down toggle-icon"></i>
    `;
    countryContainer.appendChild(countryHeader);
    areaListContainer.appendChild(countryContainer);

    const regionContainer = document.createElement('div');
    regionContainer.style.display = 'none';
    regionContainer.className = 'region-layer';
    const countryCheckbox = countryHeader.querySelector('input');

    Object.keys(hierarchy[country]).forEach(region => {
        const regionItem = document.createElement('div');
        regionItem.className = 'individual-icon-container';

        const regionHeader = document.createElement('div');
        regionHeader.innerHTML = `
            <input type="checkbox" id="region-${region}" checked>
            <span>${region}</span>
            <i class="fa-solid fa-caret-down toggle-icon"></i>
        `;
        regionItem.appendChild(regionHeader);

        const adminContainer = document.createElement('div');
        adminContainer.style.display = 'none';
        adminContainer.className = 'admin-layer';
        const regionCheckbox = regionHeader.querySelector('input');

        Object.keys(hierarchy[country][region]).forEach(adminDivision => {
            const adminItem = document.createElement('div');
            adminItem.className = 'individual-icon-container';

            const adminHeader = document.createElement('div');
            adminHeader.innerHTML = `
                <input type="checkbox" id="admin-${adminDivision}" checked>
                <span>${adminDivision}</span>
                <i class="fa-solid fa-caret-down toggle-icon"></i>
            `;
            adminItem.appendChild(adminHeader);

            const localContainer = document.createElement('div');
            localContainer.style.display = 'none';
            localContainer.className = 'local-layer';
            const adminCheckbox = adminHeader.querySelector('input');

            hierarchy[country][region][adminDivision].forEach(({ localDivision, marker }) => {
                const localItem = document.createElement('div');
                localItem.className = 'individual-icon-container';

                const localCheckbox = document.createElement('input');
                localCheckbox.type = 'checkbox';
                localCheckbox.id = `local-${localDivision}`;
                localCheckbox.checked = true;

                const localLabel = document.createElement('label');
                localLabel.htmlFor = localCheckbox.id;
                localLabel.textContent = localDivision;

                localItem.appendChild(localCheckbox);
                localItem.appendChild(localLabel);
                localContainer.appendChild(localItem);

                // マーカー連動（既存のマーカーを利用）
                localCheckbox.addEventListener('change', () => {
                    if (localCheckbox.checked) {
                        marker.addTo(map); // 地図に追加
                    } else {
                        map.removeLayer(marker); // 地図から削除
                    }
                    updateParentCheckbox(adminCheckbox, localContainer.querySelectorAll('input[type="checkbox"]'));
                    updateParentCheckbox(regionCheckbox, adminContainer.querySelectorAll('input[type="checkbox"]'));
                    updateParentCheckbox(countryCheckbox, regionContainer.querySelectorAll('input[type="checkbox"]'));
                });

                // 初期状態で表示する場合
                marker.addTo(map);
            });

            adminItem.appendChild(localContainer);

            // Admin Divisionのトグルイベント
            adminHeader.querySelector('.toggle-icon').addEventListener('click', () => {
                localContainer.style.display = localContainer.style.display === 'none' ? 'block' : 'none';
            });

            // 親チェックボックス連動
            adminCheckbox.addEventListener('change', () => {
                updateChildCheckboxes(adminCheckbox, localContainer.querySelectorAll('input[type="checkbox"]'));
            });

            adminContainer.appendChild(adminItem);
        });

        regionItem.appendChild(adminContainer);

        // Regionのトグルイベント
        regionHeader.querySelector('.toggle-icon').addEventListener('click', () => {
            adminContainer.style.display = adminContainer.style.display === 'none' ? 'block' : 'none';
        });

        // 親チェックボックス連動
        regionCheckbox.addEventListener('change', () => {
            updateChildCheckboxes(regionCheckbox, adminContainer.querySelectorAll('input[type="checkbox"]'));
        });

        regionContainer.appendChild(regionItem);
    });

    countryContainer.appendChild(regionContainer);

    // Countryのトグルイベント
    countryHeader.querySelector('.toggle-icon').addEventListener('click', () => {
        regionContainer.style.display = regionContainer.style.display === 'none' ? 'block' : 'none';
    });

    // 親チェックボックス連動
    countryCheckbox.addEventListener('change', () => {
        updateChildCheckboxes(countryCheckbox, regionContainer.querySelectorAll('input[type="checkbox"]'));
    });
});

                  
                  
                  
                  
                    // カテゴリーごとのチェックボックスの生成（階層を保持）
                    // CategoryContainerを生成するコード
                    var categoryContainer = document.getElementById('categoryContainer' + category);
                    if (!categoryContainer) {
                        categoryContainer = document.createElement('div');
                        categoryContainer.id = 'categoryContainer' + category;
                        categoryContainer.className = 'layer-group';

                        var mainCategoryDiv = document.createElement('div');
                        mainCategoryDiv.className = 'main-category';
                        mainCategoryDiv.style.display = 'flex';
                        mainCategoryDiv.style.alignItems = 'center';

                        var categoryCheckbox = document.createElement('input');
                        categoryCheckbox.type = 'checkbox';
                        categoryCheckbox.id = 'toggle' + category;
                        categoryCheckbox.checked = true;

                        // テキスト部分をspan要素で囲む（ラベルから分離する）
                        var categoryText = document.createElement('span');
                        categoryText.className = 'category-text'; // テキスト部分にクラスを追加
                        categoryText.textContent = ' ' + category;

                        // mainCategoryDivにチェックボックスとテキストを追加
                        mainCategoryDiv.appendChild(categoryCheckbox);
                        mainCategoryDiv.appendChild(categoryText);
                        categoryContainer.appendChild(mainCategoryDiv);
                        document.getElementById('listMenu').appendChild(categoryContainer);

                        // チェックボックスの状態によってマーカーを表示・非表示にするイベントリスナー
                        categoryCheckbox.addEventListener('change', function(e) {
                            if (e.target.checked) {
                                window.categoryMarkers[category].forEach(function(marker) { marker.addTo(map); });
                            } else {
                                window.categoryMarkers[category].forEach(function(marker) { map.removeLayer(marker); });
                            }

                            // 下位のチェックボックスにも同じ状態を適用
                            const subCheckboxes = categoryContainer.querySelectorAll('.individual-icon-container input[type="checkbox"]');
                            subCheckboxes.forEach(subCheckbox => {
                                subCheckbox.checked = e.target.checked;
                                // 下位のチェックボックスの変更に応じてマーカーも更新
                                if (subCheckbox.checked) {
                                    window.categoryMarkers[category].forEach(marker => marker.addTo(map));
                                } else {
                                    window.categoryMarkers[category].forEach(marker => map.removeLayer(marker));
                                }
                            });
                        });

                        // 開閉アイコンの作成
                        var toggleIcon = document.createElement('i');
                        toggleIcon.className = 'fa-solid fa-caret-down toggle-icon'; // クラス名を変更

                        // mainCategoryDivにcategoryTextの右側にアイコンを追加
                        mainCategoryDiv.appendChild(toggleIcon); // categoryTextの右側に追加

                        // 開閉機能の共通関数
                        function toggleIndividualContainers() {
                            const individualContainers = categoryContainer.querySelectorAll('.individual-icon-container');
                            let isOpen = false;

                            individualContainers.forEach(container => {
                                if (container.style.display === 'none' || container.style.display === '') {
                                    container.style.display = 'block'; // 開く
                                    isOpen = true;
                                } else {
                                    container.style.display = 'none'; // 閉じる
                                }
                            });

                            // アイコンの切り替えとスタイルの適用
                            toggleIcon.classList.toggle('fa-caret-down', !isOpen);
                            toggleIcon.classList.toggle('fa-caret-up', isOpen);
                        }

                        // category-textとtoggle-iconにクリックイベントを設定
                        categoryText.addEventListener('click', function(event) {
                            event.stopPropagation();
                            toggleIndividualContainers();
                        });

                        toggleIcon.addEventListener('click', function(event) {
                            event.stopPropagation();
                            toggleIndividualContainers();
                        });

                   }
                  
          
                  

                    // 各アイテムごとのチェックボックスとラベルの生成
                    var individualContainer = document.createElement('div');
                    individualContainer.className = 'individual-icon-container';
                    individualContainer.style.display = 'none'; // 初期状態は非表示に設定

                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = category + index;
                    checkbox.checked = true;
                    checkbox.className = 'individual-icon';
                    checkbox.addEventListener('change', function() {
                        if (checkbox.checked) {
                            marker.addTo(map);
                            polygon.addTo(map);
                        } else {
                            map.removeLayer(marker);
                            map.removeLayer(polygon);
                        }
                    });

                    var label = document.createElement('label');
                    label.htmlFor = category + index;
                    label.className = 'individual-icon';
                    label.appendChild(document.createTextNode(' ' + name));

                    // individual-iconクリックイベントをラベルに追加
                    label.addEventListener('click', function(event) {
                        event.preventDefault();  // チェックボックスの操作を防ぐ

                        // 対応するマーカーのカテゴリと名前を取得して特定
                        const marker = window.categoryMarkers[category]?.find(m => m.getPopup().getContent().includes(name));

                        if (marker) {
                            // マーカーの位置に地図を移動、アニメーションの速度を調整
                            map.flyTo(marker.getLatLng(), map.getZoom(), {
                                animate: true,
                                duration: 1.3 // 持続時間を秒単位で設定 (例: 2秒)
                            });
                            
                            // 地図の移動が終わった後にポップアップを開くための遅延を設定
                            setTimeout(() => {
                                marker.openPopup();
                            }, 1300); // flyToのdurationと同じ時間（1.3秒）を遅延させる                          
                        }
                    });

                    individualContainer.appendChild(checkbox);
                    individualContainer.appendChild(label);
                    categoryContainer.appendChild(individualContainer);

                });
            };
            reader.readAsArrayBuffer(file);
        }); 
      
      
      

        // #conditions内のチェックボックスを#PJ List内の関連する親チェックボックスと連動させる
        document.querySelectorAll('#conditions .c-checkbox input[type="checkbox"]').forEach(conditionCheckbox => {
            conditionCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;

                // 各条件のチェックボックスIDに応じた親チェックボックスを探して連動させる
                let parentCheckboxId;
                switch (this.id) {
                    case 'primary-category':
                        parentCheckboxId = 'togglePrimary';
                        break;
                    case 'condo-category':
                        parentCheckboxId = 'toggleCondominium';
                        break;
                    case 'ecoba-category':
                        parentCheckboxId = 'toggleECOBA PJ';
                        break;
                    case 'hc-category':
                        parentCheckboxId = 'toggleHC PJ';
                        break;
                    default:
                        return; // マッチするものがない場合は処理を中断
                }

                // 親チェックボックスを見つけて、その状態を更新
                const parentCheckbox = document.getElementById(parentCheckboxId);
                if (parentCheckbox) {
                    parentCheckbox.checked = isChecked;

                    // 親チェックボックスの変更に応じて、その下層のチェックボックスも連動させる
                    const individualCheckboxes = parentCheckbox.closest('.layer-group').querySelectorAll('.individual-icon-container input[type="checkbox"]');
                    individualCheckboxes.forEach(individualCheckbox => {
                        individualCheckbox.checked = isChecked;

                        // マーカーの表示・非表示を同期
                        const category = individualCheckbox.dataset.category || parentCheckboxId.replace('toggle', '').trim();
                        const name = individualCheckbox.labels[0]?.textContent.trim(); // ラベルからプロジェクト名を取得
                        const marker = window.categoryMarkers[category]?.find(m => m.getPopup().getContent().includes(name));

                        if (marker) {
                            if (isChecked) {
                                marker.addTo(map);
                            } else {
                                map.removeLayer(marker);
                            }
                        }
                    });
                }
            });
        });

      
        // 画面ローテーションでリロード
        function handleOrientationChange() {
          if (window.matchMedia("(orientation: portait)").matches) {
            document.body.style.width = "100%";
          } else if (window.matchMedia("(orientation: landscape)").matches) {
            document.body.style.width = "100vw";
          }
        }

        window.addEventListener("orientationchange", handleOrientationChange);
        window.addEventListener("resize", handleOrientationChange);
        handleOrientationChange(); 
    </script>
</body>
</html>
