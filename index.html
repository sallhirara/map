
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mapping system</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.1/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
        }

        .menu-container {
            color: #333;
            display: flex;
            height: 30px;
            width: 90%;
            justify-content: flex-start;
            margin: 5px 20px;
            position: relative;
        }

        .custom-file-upload {
            color: #333;
            font-size: 20px;
            margin-right: 10px;
            display: inline-block;
            padding: 4px 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .custom-file-upload:hover {
            background-color: #ddd;
        }

        #fileUpload {
            display: none;
        }
        
        .menu-button,
        .save-button,
        .reset-button {
            margin: 0 5px;
            padding: 5px 10px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: transparent;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #333;
        }

        .menu-button i {
            margin-left: 10px;
        }

        .save-button {
            margin-left: 30px;
        }

        .menu-button:hover,
        .save-button:hover,
        .reset-button:hover {
            background-color: #ddd;
        }

        .mega-menu {
            display: none;
            position: absolute;
            width: 90%;
            max-width: 500px;
            overflow-y: hidden;
            left: 5%;

            border-radius: 8px;
            padding: 0px;
            z-index: 1001;
            font-size: 12px;
            top: 60px; /* menu-container (30px) + margin (10px) を考慮 */
            transform: translateY(-20px); /* 初期状態で少し上に隠しておく */
            opacity: 0; /* 初期は非表示 */
            transition: transform 0.7s ease, opacity 0.7s ease, top 0.7s ease; /* アニメーションをゆっくりに変更 */
        }
      
        .mega-menu::-webkit-scrollbar {
          display: none; /* Chrome, Safari, Opera のスクロールバーを非表示 */
        }
        
        .mega-menu::before {
            content: "";
            position: absolute;
            top: -20px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-width: 10px;
            border-style: solid;
            border-color: transparent transparent #ffffff transparent;
        }


        /* -------- Summary from here --------*/
        #summary {
            padding: 20px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.3); /* 半透明 */
            backdrop-filter: blur(5px);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        /* -------- Summary to here --------*/


        /* -------- Conditions from here --------*/
        #conditions {
            padding: 20px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.3); /* 半透明 */
            backdrop-filter: blur(5px);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
      
        .button-container {
            display: flex;
            justify-content: space-around; /* ボタンを均等配置 */
            align-items: center; /* ボタンを垂直方向に中央揃え */
            margin-bottom: 20px; /* 上下の余白を追加 */
        } 

        .jump-button {
            height: 25px;
            width: 80px;
            padding: 5px 10px;
            border: none;
            border-radius: 12px;
            background-color: rgba(159, 159, 159, 0.3);
            color: #333;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;      
        }

        .jump-button:hover {
            background-color: #00258F85;
            color: white;
        }      

        /* radio */
        .scale-radio,
        .circle-radio {
            border: none;
            /*　radio items の割り付けグリッド４分割　*/
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 横に4分割 */
            grid-template-rows: repeat(1, 1fr);    /* 縦に2分割 */
            gap: 0px;                             /* 各アイテム間のスペース */             
        }
      
        .circle-radio {
          margin-bottom: 10px;
        }

        .sc-radio,
        .cc-radio {
            border: none;
            padding: 3px 6px;
            border-radius: 50px;
            display: inline-flex;
            cursor: pointer;
            transition: background 0.2s ease;
            margin: 0px;
            -webkit-tap-highlight-color: transparent;
        }

        .sc-radio:hover,
        .cc-radio:hover,
        .sc-radio:focus-within,
        .cc-radio:focus-within {
            background: rgba(159, 159, 159, 0.3); /* $secondary color in RGBA */
        }

        .sc-radio input,
        .cc-radio input {
            vertical-align: middle;
            width: 16px;
            height: 16px;
            border-radius: 10px;
            background: none;
            border: 0;
            box-shadow: inset 0 0 0 1.5px #9F9F9F; /* $secondary color */
            appearance: none;
            padding: 0;
            margin: 0;
            transition: box-shadow 150ms cubic-bezier(0.95, 0.15, 0.5, 1.25);
            pointer-events: none;
        }

        .sc-radio input:focus,
        .cc-radio input:focus {
            outline: none;
        }

        .sc-radio input:checked,
        .cc-radio input:checked {
            box-shadow: inset 0 0 0 5px #00258F85; /* $primary color */
        }

        .sc-radio span,
        .cc-radio span {
            vertical-align: middle;
            display: inline-block;
            line-height: 16px;
            padding: 0 8px;
        }
      
        .statusLabels {
            display: flex;
            justify-content: flex-start; /* Align content to the left */
            text-align: left; /* Ensure text aligns to the left */
            margin: 12px 0 5px 5px; /* Adjust margins as needed */
            color: #333;
        }
        /* radio */


        /* checkbox */
        .category-checkbox,
        .condoStatus-checkbox,
        .ecobaStatus-checkbox {
            border: none;
            margin-bottom: 10px;            
            /*　checkbox　item の均等割り付け　*/
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 横に2分割 */
            grid-template-rows: repeat(1, 1fr);    /* 縦に2分割 */
            gap: 0px;                             /* 各アイテム間のスペース */     
        }

        /* condo, ecobaStatus-checkboxでstatus制御*/
        .hidden {
            display: none !important;
        }

        .c-checkbox,
        .st-checkbox {
            border: none!important;
            padding: 4px 6px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2 ease;
            margin: 0px;
            -webkit-tap-highlight-color: transparent;
        }

        .c-checkbox:hover,
        .st-checkbox:hover,
        .c-checkbox:focus-within,
        .st-checkbox:focus-within {
            background: rgba(159, 159, 159, 0.3); /* $secondary color in RGBA */
            border-radius: 10px !important;
        }

        .c-checkbox input,
        .st-checkbox input {
            vertical-align: middle !important;
            width: 16px !important;
            height: 16px !important;
            border-radius: 6px !important;
            background: none !important;
            border: 0 !important;
            box-shadow: inset 0 0 0 1.5px #9F9F9F !important; /* $secondary color */
            appearance: none !important;
            padding: 0 !important;
            margin: 0 !important;
            transition: box-shadow 150ms cubic-bezier(0.95, 0.15, 0.5, 1.25) !important;
            pointer-events: none !important;
        }

        .c-checkbox input:focus,
        .st-checkbox input:focus {
            outline: none !important;
        }

        .c-checkbox input:checked,
        .st-checkbox input:checked {
            box-shadow: inset 0 0 0 10px #00258F85 !important; /* $primary color */
        }

        .c-checkbox input[type="checkbox"]:checked::before,
        .st-checkbox input[type="checkbox"]:checked::before {
            color: lightgray !important;
        }        

        .c-checkbox span,
        .st-checkbox span {
            vertical-align: middle;
            display: inline-block;
            line-height: 16px;
            padding: 0 8px;
        }
        /* checkbox */

        
        /* area list */      
        #area-list-container {
            max-height: 170px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 0 6px;
            -ms-overflow-style: none;  /* IEとEdgeでスクロールバーを非表示 */
            scrollbar-width: none;  /* Firefoxでスクロールバーを非表示 */          
        }      

        /* アニメーション付きのトグルコンテンツ */
        .child-container {
            overflow: hidden; /* 内容がはみ出さないように隠す */
            max-height: 0; /* 初期状態では高さを0に */
            opacity: 0; /* 初期状態で透明 */
            transition: max-height 0.7s ease-out, opacity 0.7s ease-out; /* max-heightとopacityにトランジションを設定 */
        }

        .country-layer label,
        .region-layer label,
        .admin-layer label,
        .local-layer label {
            padding-left: 5px;
        }

        .child-container.open {
            max-height: 170px; /* 任意の高さに設定（十分大きな値にする） */
            opacity: 1; /* 表示させる */
        }            
        
        .country-layer {
            margin: 0 0 4px 0; /* Countryレイヤーのインデント */  
            font-size: 14px;
            font-weight: bolder;
            color: #555;
        }

        .region-layer {
            margin: 0 0 0px 10px; /* Regionレイヤーのインデント */
            font-size: 12px;
            font-weight: normal;
            color: #333;
        }

      
        .admin-layer {
            margin: 0 0 0px 15px; /* Administrative Divisionレイヤーのインデント */
        }

        .local-layer {
            margin: 0 0 0px 20px; /* Local Divisionレイヤーのインデント */
        }
        /* aria list */    
      
      
        /* slider */
       #price-slider {
            margin: 10px 0px 30px 5px;
            height: 10px; /* スライダーバーの高さを変更 */
            width: 95%;
            background-color: transparent;
        }

      
        .noUi-connect {
            background: #00258F85; /* 選択範囲の色を変更 */
        }  
        .noUi-handle {
            background: #00258F85;
            border: 2px solid #ffffff;
            width: 20px !important;
            height: 20px !important;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }          
      
        /* スライダーの現在の範囲ラベル */
        .slider-value-labels {
            color: #333;
            text-align: left;
            margin: 10px 0 12px 5px;
        }
      
        /* sloder */      
      
        /* -------- Conditions to here --------*/


        /* -------- PJ List from here --------*/
        #listMenu {
            border: none;
            font-size: 12px;
        }

        #pjSearch { /* style は Javascriptで設定*/
            padding: 5px 15px !important; /* 内側の余白 */
            font-size: 16px !important; /* フォントサイズ */
            border: 1px solid #ccc; /* ボーダー色 */
            border-radius: 20px !important; /* 角を丸める */
            background-color: #f9f9f9 !important; /* 背景色 */
            outline: none !important; /* フォーカス時の青い枠を消す */
            transition: border-color 0.3s ease; /* フォーカス時のボーダー色をアニメーション */
        }

        #pjSearch:focus {
            border-color: #00258F !important; /* フォーカス時のボーダー色 */
            background-color: #fff !important; /* フォーカス時の背景色 */
        }        

        #pjList {
            display: block;
            position: absolute;
            width: 100%;
            max-height: 100%;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            transition: none;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            font-size: 12px;
        }
        
        #pjList::-webkit-scrollbar {
        display: none;
        }


        /*Category 1 毎 のコンテナ*/
        .layer-group {
            margin-bottom: 10px;
        }
        
        /*Category 1 のヘッダーコンテナ*/
        .main-category {
            margin-bottom: 10px;
        }

        /*Category 1 のテキスト部分*/
        .category-text {
            padding-left: 10px;
            font-size: 14px;
            font-weight: bolder;
            color: #555;
            cursor: pointer;
        }

        /* アイコンの共通スタイル */
        .toggle-icon {
            height: 18px;
            padding: 2px 5px 2px 17px;
            color: #999; /* 開いた状態で色を変更 */
        }

        /* 開いているときのスタイル */
        .toggle-icon.open {
            color: #999; /* 開いた状態で色を変更 */
        }

        /*PJ Name それぞれのコンテナ*/
        .individual-icon-container {
            margin-bottom: 5px;
        }

        .individual-icon {
            margin-left: 10px;
            cursor: alias;
        }

        input[type="checkbox"] {
            vertical-align: middle;
            appearance: none;
            width: 16px;
            height: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            display: inline-block;
        }

        input[type="checkbox"]:checked {
            font-size: 9px;
            background-color: #D93E1A85;
            border: none;
            position: relative;
        }

        input[type="checkbox"]:checked::before {
            content: '\2714';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
        }
        /* -------- PJ List to here --------*/


        #map {
            position: absolute;
            height: calc(100% - 40px); /* menu-container の高さ +margin を考慮 */
            width: 100%;
            top: 40px; /* menu-container の高さ分だけ下にずらす */
        }
      
        #mapToggleIcon {
            transition: transform 0.3s ease;
        }

        #mapToggleIcon:hover {
            transform: scale(1.1);
        }

        #togglePositionButton {
            background: none;
            border: none; /* 枠線 */
            padding: 0px; /* 小さな内側の余白 */
            width: 30px; /* ボタンの幅 */
            height: 30px; /* ボタンの高さ */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px; /* アイコンのサイズ */
            cursor: pointer;
        }

        #togglePositionButton i {
            font-size: 14px; /* アイコンをさらに小さくする */
        }
      
      
        .zoom-control-container {
            position: fixed; /* 画面全体に対する配置を固定 */
            bottom: 20px;    /* 下からの距離 */
            right: 12px;     /* 初期設定は右下 */
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;   /* 他の要素より上に表示 */
            gap: 10px;       /* 子要素間の間隔 */
        }

        .zoom-control-container button {
            color: #333;
            opacity: 0.5;
            border-radius: 50%;
            background-color: none;
        }

        .zoom-control-container button:hover {
            transform: scale(1.1);
        }


        /* ポリゴンのポップアップのデザイン */
        .polygon-popup {
            color: #333; /* テキストカラー */
            font-family: Arial, sans-serif; /* フォント */
            font-size: 14px; /* フォントサイズ */
            border-radius: 10px; /* 角を丸くする */
            padding: 10px; /* 内側の余白 */
            line-height: 1.4; /* 行間 */
        }

        /* ポリゴンのポップアップ内のリンク */
        .polygon-popup a {
            color: #00258f; /* 青いリンク */
            text-decoration: underline;
            font-weight: bold;
        }

        /* ポリゴンのポップアップ内のリンクにホバー時のスタイル */
        .polygon-popup a:hover {
            color: none; /* オレンジ色に変更 */
            text-decoration: none;
        }    
      

    </style>
</head>
<body>
    <div class="menu-container">
        <label for="fileUpload" class="custom-file-upload"><i class="fa-solid fa-file-arrow-down"></i></label>
        <input type="file" id="fileUpload" accept=".xlsx,.xlsm" />
        <button class="menu-button" onclick="toggleMenu('summary', this)">SUM.<i class="fa-solid fa-caret-down"></i></button>
        <button class="menu-button" onclick="toggleMenu('conditions', this)">COND.<i class="fa-solid fa-caret-down"></i></button>
        <button class="menu-button" onclick="toggleMenu('listMenu', this)">LIST<i class="fa-solid fa-caret-down"></i></button>

        <button class="save-button" type="button" date-action=""><i class="fa fa-save"></i></button>
        <button class="reset-button" type="button" date-action=""><i class="fa-solid fa-arrows-rotate"></i></button>
    </div>
    <!-- Summary -->
    <div id="summary" class="mega-menu">
        <ul>
            <li>Number of PJ</li>
            <li>Number of Units</li>
            <br>
            <li>Average Unit Price</li>
            <li>Highest Price</li>
            <li>Lowest Price</li>
            <li>Middle Price</li>
        </ul>
    </div>

    <!--- Conditions -->
    <div id="conditions" class="mega-menu">
        <!-- radio button for center -->
        <div id="area-buttons" class="button-container">
            <button class="jump-button" onclick="jumpToLocation('hn-area')">Hanoi</button>
            <button class="jump-button" onclick="jumpToLocation('hcm-area')">HCMC</button>
            <button class="jump-button" onclick="jumpToLocation('hp-area')">Hai Phong</button>
            <button class="jump-button" onclick="jumpToLocation('vn-area')">Vietnam</button>
        </div>
        <!-- radio butto- for center-->

        <!-- radio button for scale -->
        <div id="scale-radio" class="scale-radio">

            <label for="sc-50000" class="sc-radio">
                <input type="radio" id="sc-50000" name="selector2" tabindex="1" checked>
                <span>1/50,000</span>
            </label>   
            <label for="sc-10000" class="sc-radio">
                <input type="radio" id="sc-10000" name="selector2" tabindex="2">
                <span>1/10,000</span>
            </label> 
            <label for="sc-2000" class="sc-radio">
                <input type="radio" id="sc-2000" name="selector2" tabindex="3">
                <span>1/2,000</span>
            </label>          
            <label for="sc-1000" class="sc-radio">
                <input type="radio" id="sc-1000" name="selector2" tabindex="4">
                <span>1/1000</span>
            </label>      
        </div>
        <!-- radio button for scale-->
 
       <!-- radio button for circle -->
        <div id="circle-radio" class="circle-radio">

            <label for="cc-5" class="cc-radio">
                <input type="radio" id="cc-5" name="selector3" tabindex="1" checked>
                <span>5km</span>
            </label>   
            <label for="cc-10" class="cc-radio">
                <input type="radio" id="cc-10" name="selector3" tabindex="2">
                <span>10km</span>
            </label> 
            <label for="cc-100" class="cc-radio">
                <input type="radio" id="cc-100" name="selector3" tabindex="3">
                <span>100km</span>
            </label>          
            <label for="cc-none" class="cc-radio">
                <input type="radio" id="cc-none" name="selector3" tabindex="4">
                <span>None</span>
            </label>      
        </div>
        <!-- radio button for circle-->      
      
        <!-- check box -->
        <label id="categoryCheckboxLabel" class=statusLabels>Project Categories</label>
        <div id="category-checkbox" class="category-checkbox">
            <label for="primary-category" class="c-checkbox">
                <input type="checkbox" id="primary-category" name="selector" tabindex="1" checked>
                <span>Primary</span>
            </label>
            <label for="areaDev-category" class="c-checkbox">
                <input type="checkbox" id="areaDev-category" name="selector" tabindex="2" checked>
                <span>Area</span>
            </label>            
            <label for="hc-category" class="c-checkbox">
                <input type="checkbox" id="hc-category" name="selector" tabindex="3" checked>
                <span>Haseko</span>
            </label>
            <label for="ecoba-category" class="c-checkbox">
                <input type="checkbox" id="ecoba-category" name="selector" tabindex="4" checked>
                <span>Ecoba</span>
            </label>            
            <label for="condo-category" class="c-checkbox">
                <input type="checkbox" id="condo-category" name="selector" tabindex="5" checked>
                <span>Condo</span>
            </label>
            <label for="site-category" class="c-checkbox">
                <input type="checkbox" id="site-category" name="selector" tabindex="6" checked>
                <span>PJ Site</span>
            </label>
            <label for="other-category" class="c-checkbox">
                <input type="checkbox" id="other-category" name="selector" tabindex="7" checked>
                <span>Others</span>
            </label>            
        </div>
        <!-- check box -->
  
        <!-- Condo status box -->
        <label id="condoStatus" class=statusLabels>Status : Condominium PJ</label>
        <div id="condoStatus-checkbox" class="condoStatus-checkbox">
            <label for="prep-category" class="st-checkbox">
                <input type="checkbox" id="prep-category" name="selector" tabindex="1" checked>
                <span>Prep</span>
            </label>
            </label>
            <label for="active-category" class="st-checkbox">
                <input type="checkbox" id="active-category" name="selector" tabindex="2" checked>
                <span>Active</span>
            </label>            
            <label for="soldOut-category" class="st-checkbox">
                <input type="checkbox" id="soldOut-category" name="selector" tabindex="3" checked>
                <span>sold</span>
            </label>
            <label for="poused-category" class="st-checkbox">
                <input type="checkbox" id="poused-category" name="selector" tabindex="4" checked>
                <span>Paused</span>
            </label>                    
        </div>
        <!-- Condo status box -->  

        <!-- slider -->
        <div id="condo-price-slider" class="condo-price-slider">
            <div class="slider-value-labels">
                Price Range: <span id="sliderValueMin">$500</span> - <span id="sliderValueMax">$1,000</span>
            </div>
            <div id="price-slider"　calss="slider"></div>
        </div>
        <!-- slider -->


        <!-- ECOBA status box -->
        <!--<label id="constructionStatus" class=statusLabels>PJ Status - Construction</label>-->
        <label id="ecobaStatus" class=statusLabels>Status : Construction PJ</label>        
        <div id="ecobaStatus-checkbox" class="ecobaStatus-checkbox">
            <label for="preBid-category" class="st-checkbox">
                <input type="checkbox" id="preBid-category" name="selector" tabindex="1" checked>
                <span>PreBid</span>
            </label>
            </label>
            <label for="tender-category" class="st-checkbox">
                <input type="checkbox" id="tender-category" name="selector" tabindex="2" checked>
                <span>Tender</span>
            </label>            
            <label for="constr-category" class="st-checkbox">
                <input type="checkbox" id="constr-category" name="selector" tabindex="3" checked>
                <span>Constr</span>
            </label>
            <label for="Comp-category" class="st-checkbox">
                <input type="checkbox" id="Comp-category" name="selector" tabindex="4" checked>
                <span>Comp</span>
            </label>                    
        </div>
        <!-- ECOBA status box -->    

  
        <!-- Area list container-->
        <div id="area-list-container" class="area-list-container">
        </div>
        <!-- Area List -->
      
    </div>

    <!-- PJ List -->
    <div id="listMenu" class="mega-menu">
        <div style="position: relative; display: flex; align-items: center; gap: 10px;">
            <input type="text" id="pjSearch" placeholder="Search Projects..." 
                   style="width: calc(100% - 70px); padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <i id="pjListToggleIcon" class="fa-solid fa-angles-down" style="margin-bottom: 10px; cursor: pointer; font-size: 18px;"></i>
        </div>
        <div class="pjList" id="pjList"></div> <!-- Project Listをクリックした際に開くメニュー -->
    
    </div>
  

    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.1/nouislider.min.js"></script> <!-- for slider-->
    <script>
        
        // スライダーを実装
        var slider = document.getElementById('price-slider');
        noUiSlider.create(slider, {
          start: [0, 1500],
          connect: true,
          range: {
            'min': 0,
            'max': 10000
          }
        });      

        // condo-checkboxでcondoStatus / ecoba-checkboxでecobaStatus制御
        document.addEventListener('DOMContentLoaded', function () {
            const categories = [
                {
                    checkboxId: 'condo-category',
                    statusId: 'condoStatus',
                    checkboxGroupId: 'condoStatus-checkbox',
                    additionalElementId: 'condo-price-slider' // Add the slider control
                },
                {
                    checkboxId: 'ecoba-category',
                    statusId: 'ecobaStatus',
                    checkboxGroupId: 'ecobaStatus-checkbox'
                }
            ];

            // Function to update the visibility of elements based on the checkbox state
            function updateVisibility(category) {
                const checkbox = document.getElementById(category.checkboxId);
                const statusElement = document.getElementById(category.statusId);
                const checkboxGroupElement = document.getElementById(category.checkboxGroupId);
                const additionalElement = category.additionalElementId
                    ? document.getElementById(category.additionalElementId)
                    : null; // Additional element like the slider

                if (!checkbox || !statusElement || !checkboxGroupElement) {
                    console.error(`Elements for ${category.checkboxId} not found.`);
                    return;
                }

                const isChecked = checkbox.checked;
                statusElement.classList.toggle('hidden', !isChecked);
                checkboxGroupElement.classList.toggle('hidden', !isChecked);

                // Handle additional element visibility (like the slider)
                if (additionalElement) {
                    additionalElement.classList.toggle('hidden', !isChecked);
                }

                // Adjust #listMenu height dynamically
                adjustMenuHeight();
            }

            // Initialize and add event listeners
            categories.forEach(category => {
                const checkbox = document.getElementById(category.checkboxId);
                if (checkbox) {
                    updateVisibility(category); // Initialize visibility
                    checkbox.addEventListener('change', () => updateVisibility(category));
                }
            });
        });

        // 現在の範囲を表示するラベル
        var valueMinLabel = document.getElementById('sliderValueMin');
        var valueMaxLabel = document.getElementById('sliderValueMax');

        // スライダーの値が変更されたときにラベルを更新
        slider.noUiSlider.on('update', function (values, handle) {
            valueMinLabel.textContent = Math.round(values[0]);
            valueMaxLabel.textContent = Math.round(values[1]);
        });   
      
      
        function toggleMenu(menuId, button) {
            const menu = document.getElementById(menuId);

            if (menu.style.display === 'block') {
                menu.style.transform = 'translateY(-20px)';
                menu.style.opacity = '0'; // フェードアウト効果
                document.body.style.overflow = ''; // スクロールを有効化                
                setTimeout(() => {
                    menu.style.display = 'none';             
                    menu.style.top = "60px"; // 初期位置にリセット（menu-container の下）
                    adjustMenuHeight(); // メニュー高さを再計算
                    adjustMenuPositions(); // メニュー位置の再調整
                }, 500);
            } else {
                menu.style.display = 'block';
                setTimeout(() => {
                    menu.style.transform = 'translateY(0)'; // スライドダウン
                    menu.style.opacity = '1'; // フェードイン効果
                    document.body.style.overflow = 'hidden'; // スクロールを無効化
                    adjustMenuHeight(); // メニュー高さを再計算
                    adjustMenuPositions(); // メニュー位置の再調整
                }, 0);
            }
        }
      
        function adjustMenuHeight() {
            const pjList = document.getElementById('pjList');
            const listMenu = document.getElementById('listMenu');
            const summary = document.getElementById('summary');
            const conditions = document.getElementById('conditions');
            const areaListContainer = document.getElementById('area-list-container');

            const vh = window.innerHeight; // ビューポート全体の高さ
            const menuContainerHeight = 30; // メニューコンテナの高さ
            const bottomMargin = 100; // 余白として 100px を引く

            // summary と conditions の高さを取得
            const summaryHeight = summary.style.display === 'block' ? summary.getBoundingClientRect().height : 0;
            const conditionsHeight = conditions.style.display === 'block' ? conditions.getBoundingClientRect().height : 0;

            // max-height の計算
            let newMaxHeight = vh - summaryHeight - conditionsHeight - bottomMargin;

            // 設定
            listMenu.style.maxHeight = `${newMaxHeight}px`;

            // menu の通常の高さを設定（省略せずに記述）
            let newHeight = vh - menuContainerHeight - bottomMargin;
            if (summaryHeight > 0) {
                newHeight -= summaryHeight;
            }
            if (conditionsHeight > 0) {
                newHeight -= conditionsHeight;
            }
            listMenu.style.height = `${newHeight}px`;

            adjustMenuPositions();
        }

        // ResizeObserverを使用してarea-list-containerの高さの変化を監視
        const areaListObserver = new ResizeObserver(() => {
            adjustMenuHeight(); // 高さの変化に応じてメニューの高さを再計算
        });

        const areaListContainer = document.getElementById('area-list-container');
        areaListObserver.observe(areaListContainer);


        
        function adjustMenuPositions() {
            const visibleMenus = Array.from(document.querySelectorAll('.mega-menu'))
                .filter(menu => menu.style.display === 'block');

            let offsetTop = 60; // 初期のmenu-containerの高さ分を加算

            visibleMenus.forEach(menu => {
                // アニメーションを適用して位置を変更
                menu.style.top = `${offsetTop}px`;
                offsetTop += menu.getBoundingClientRect().height + 10; // メニュー間の余白を加算
            });
        }


        // ウィンドウのサイズが変更された時にメニューの高さを調整
        window.addEventListener('resize', adjustMenuHeight);
      
        // ユーザーがモバイルデバイスを使用しているかを判定
        const isMobile = /Mobi|Android|iPhone|iPad|iPod/.test(navigator.userAgent);

        // デバイスに応じた初期ズームレベルを設定
        const initialZoom = isMobile ? 11 : 12;

      
        // 地図の初期化
        // デバイスに適したズームレベルで地図を初期化
        var map = L.map('map', { zoomControl: false }).setView([21.03966820428092, 105.86461819490408], initialZoom);

        // カスタムズームコントロールを右下に追加
        // L.control.zoom({
        //    position: 'bottomright' // 右下に配置
        // }).addTo(map);    

        // ズームボタン用のコンテナを作成
        // 初期設定は右下
        let isBottomRight = true;

        // カスタムズームコントロールを右下に追加
        var zoomControlContainer = L.control({ position: 'bottomright' });

        zoomControlContainer.onAdd = function () {
            var div = L.DomUtil.create('div', 'zoom-control-container');
            div.innerHTML = `
                <button id="togglePositionButton" style="margin-bottom: 10px;">
                    <i class="fa-solid fa-angles-left"></i>
                </button>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                    <button id="zoomInIcon" style="background: none; border: none; cursor: pointer; font-size: 24px;">
                        <i class="fa-solid fa-circle-plus"></i>
                    </button>
                    <button id="zoomOutIcon" style="background: none; border: none; cursor: pointer; font-size: 24px;">
                        <i class="fa-solid fa-circle-minus"></i>
                    </button>
                </div>
            `;

            // 位置切り替えボタンの動作
            div.querySelector('#togglePositionButton').addEventListener('click', () => {
                const container = document.querySelector('.zoom-control-container');
                const toggleIcon = document.querySelector('#togglePositionButton i');

                // 確実に画面下に配置
                container.style.position = 'fixed';
                container.style.bottom = '20px';
                if (isBottomRight) {
                    container.style.left = '25px';
                    container.style.right = 'auto';
                    toggleIcon.className = 'fa-solid fa-angles-right';
                } else {
                    container.style.right = '12px';
                    container.style.left = 'auto';
                    toggleIcon.className = 'fa-solid fa-angles-left';
                }
                isBottomRight = !isBottomRight;
            });

            return div;
        };

        zoomControlContainer.addTo(map);

         // ズームインイベント（スムーズ）
        document.getElementById('zoomInIcon').addEventListener('click', function () {
            map.flyTo(map.getCenter(), map.getZoom() + 1, { animate: true, duration: 0.7 });
        });

        // ズームアウトイベント（スムーズ）
        document.getElementById('zoomOutIcon').addEventListener('click', function () {
            map.flyTo(map.getCenter(), map.getZoom() - 1, { animate: true, duration: 0.7 });
        });     
      
        // ダブルクリックズームを無効化
        map.doubleClickZoom.disable();
      
        // ダブルクリックされた場所を地図の中心にスムーズに移動
        map.on('dblclick', function(e) {
            const latlng = e.latlng; // ダブルクリックされた位置の緯度経度

            // アニメーション付きで移動
            map.flyTo(latlng, map.getZoom(), {
                animate: true,
                duration: 0.7 // アニメーションの持続時間（秒）
            });
        });



        function jumpToLocation(areaId) {
            const locations = {
                'hn-area': { coords: [21.03966820428092, 105.86461819490408], zoom: initialZoom }, // Hanoi
                'hcm-area': { coords: [10.787176769219485, 106.69384890636728], zoom: initialZoom }, // HCMC
                'hp-area': { coords: [20.847679772548155, 106.69874274275475], zoom: initialZoom }, // Hai Phong
                'vn-area': { coords: [15.9265619930092, 105.9142312190458], zoom: 6 } // Vietnam (wide view)
            };

            const location = locations[areaId];
            if (location) {
                map.flyTo(location.coords, location.zoom, {
                    animate: true,
                    duration: 1.5 // Animation duration in seconds
                });
            }
        }


      
        
        // 各縮尺に対応するズームレベルの定義
        // これは概算であり、地図の中心位置やデバイスによって異なる場合があります
        document.querySelectorAll('#conditions .sc-radio input[type="radio"]').forEach(function(radio) {
            radio.addEventListener('change', function(event) {
                if (event.target && event.target.id.startsWith('sc-')) {
                    let zoomLevel;
                    switch (event.target.id) {
                        case 'sc-1000':
                            zoomLevel = 18;
                            break;
                        case 'sc-2000':
                            zoomLevel = 17;
                            break;
                        case 'sc-10000':
                            zoomLevel = 15;
                            break;
                        case 'sc-50000':
                            zoomLevel = 12;
                            break;                
                        default:
                            zoomLevel = 12; // デフォルトのズームレベル
                    }
                    map.setZoom(zoomLevel, {
                        animate: true,
                        duration: 1.5
                    });
                }
            });
        });
      

        // MapTilerタイルレイヤーの設定
        var mapTilerApiKey = 'Sv80uSRLZxFEwRiW17Cg';

        // Street View タイルレイヤー
        var streetLayer = L.tileLayer(`https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=${mapTilerApiKey}`, {
            attribution: '&copy; <a href="https://www.maptiler.com/copyright/">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);

        // Aerial View (Satellite) タイルレイヤー
        var aerialLayer = L.tileLayer(`https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=${mapTilerApiKey}`, {
            attribution: '&copy; <a href="https://www.maptiler.com/copyright/">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        });

        // 地図切り替えボタン用のコンテナを作成
        var mapToggleContainer = L.control({ position: 'topright' });

        mapToggleContainer.onAdd = function () {
            var div = L.DomUtil.create('div', 'map-toggle-container');
            div.innerHTML = `
                <img id="mapToggleIcon" src="https://img.icons8.com/?size=100&id=2m4kkop8aUO5&format=png&color=000000" 
                    style="width: 40px; height: 40px; cursor: pointer; margin-right: 7px; " title="Switch to Street View" />
            `;
            return div;
        };

        mapToggleContainer.addTo(map);

        // 現在のレイヤーを追跡
        var currentLayer = streetLayer;

        // 地図切り替えイベント
        document.getElementById('mapToggleIcon').addEventListener('click', function () {
            if (currentLayer === streetLayer) {
                // Aerial View に切り替え
                map.removeLayer(streetLayer);
                aerialLayer.addTo(map);
                currentLayer = aerialLayer;

                // アイコンを変更
                this.src = "https://img.icons8.com/?size=100&id=YLlkKxgG5qUc&format=png&color=000000";
                this.title = "Switch to Street View";
            } else {
                // Street View に切り替え
                map.removeLayer(aerialLayer);
                streetLayer.addTo(map);
                currentLayer = streetLayer;

                // アイコンを変更
                this.src = "https://img.icons8.com/?size=100&id=2m4kkop8aUO5&format=png&color=000000";
                this.title = "Switch to Aerial View";
            }
        });
      
      

        // Category 1の値に基づくアイコンURLを定義
        var categoryIcons = {
            "Haseko": "https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=FF0062", // 新規検討案件のアイコン
            "PJ Site": "https://img.icons8.com/?size=100&id=ipgAkdE46kxu&format=png&color=000000", // サイトのアイコン          
            "Area": "https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=05227AA8", // 面開発案件のアイコン
            "Ecoba": "https://img.icons8.com/?size=100&id=42P5zkOQICqY&format=png&color=000000", // ECOBAのアイコン
            "Condominium": "https://img.icons8.com/?size=100&id=uRRFz0DH6uYw&format=png&color=000000", // Condominiumのアイコン
            "Others": "https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=8A8A02A8" // 新規検討案件のアイコン
        };

        
        // 円を追加
        var centerCircle = L.circle(map.getCenter(), {
            color: 'blue',         // 枠線の色
            weight: 0.8,           // 枠線の太さ
            opacity: 0.5,          // 枠線の透明度
            fillColor: 'none',     // 塗りつぶしの色
            fillOpacity: 0.1,      // 塗りつぶしの透明度
            radius: 5000           // 半径 5000m（5km）
        }).addTo(map);
      
        // 現在の円を保持する変数
        let currentCircle = centerCircle;

         
        // 中心マーカー追加
        var centerMarker = L.marker(map.getCenter(), {
            icon: L.divIcon({
                className: 'fa-icon-marker',
                html: '<i class="fa-solid fa-bullseye" style="color: blue; font-size: 10px; opacity: 0.5;"></i>',
                iconAnchor: [6, 8.5]
            })
        }).addTo(map);


      

        // ラジオボタンの変更イベントを追加
        document.querySelectorAll('#circle-radio input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const selectedId = this.id;

                // 半径を設定する変数
                let newRadius;

                // 半径を選択に応じて設定
                switch (selectedId) {
                    case 'cc-5':
                        newRadius = 5000; // 5 km
                        break;
                    case 'cc-10':
                        newRadius = 10000; // 10 km
                        break;
                    case 'cc-100':
                        newRadius = 100000; // 100 km
                        break;
                    case 'cc-none':
                        newRadius = 0; // 非表示
                        break;
                    default:
                        newRadius = 5000; // デフォルトで5 km
                }

                if (newRadius > 0) {
                    // 半径を変更し、円とマーカーを表示
                    currentCircle.setRadius(newRadius);
                    currentCircle.setStyle({ opacity: 0.5, fillOpacity: 0.1 });
                    if (!map.hasLayer(centerMarker)) {
                        centerMarker.addTo(map); // マーカーを表示
                    }
                } else {
                    // 非表示の場合は透明に設定し、マーカーを非表示
                    currentCircle.setStyle({ opacity: 0, fillOpacity: 0 });
                    if (map.hasLayer(centerMarker)) {
                        map.removeLayer(centerMarker); // マーカーを非表示
                    }
                }
            });
        });

        // 地図の移動やズーム後にアニメーション付きで円とマーカーを追従
        map.on('moveend zoomend', function () { // "zoomed" を "zoomend" に修正
            // 地図の中心座標を一度だけ取得
            const newCenter = map.getCenter();

            smoothlyMoveCircle(currentCircle, newCenter);
            smoothlyMoveMarker(centerMarker, newCenter);    
        });



        // 滑らかに円を移動させる関数（既存）
        function smoothlyMoveCircle(circle, newLatLng, duration = 700) {
            const startLatLng = circle.getLatLng();
            const startTime = performance.now();

            function animateMove() {
                const currentTime = performance.now();
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // イージングを適用
                const easedProgress = easeInOutQuad(progress);

                // 線形補間にイージングを適用して位置を計算
                const interpolatedLat = startLatLng.lat + easedProgress * (newLatLng.lat - startLatLng.lat);
                const interpolatedLng = startLatLng.lng + easedProgress * (newLatLng.lng - startLatLng.lng);

                circle.setLatLng([interpolatedLat, interpolatedLng]);

                if (progress < 1) {
                    requestAnimationFrame(animateMove);
                }
            }
            requestAnimationFrame(animateMove);
        }
      
        function smoothlyMoveMarker(marker, newLatLng, duration = 700) {
            const startLatLng = marker.getLatLng();
            const startTime = performance.now();

            function animateMove() {
                const currentTime = performance.now();
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                const easedProgress = easeInOutQuad(progress);
                const interpolatedLat = startLatLng.lat + easedProgress * (newLatLng.lat - startLatLng.lat);
                const interpolatedLng = startLatLng.lng + easedProgress * (newLatLng.lng - startLatLng.lng);

                marker.setLatLng([interpolatedLat, interpolatedLng]);

                if (progress < 1) {
                    requestAnimationFrame(animateMove);
                } else {
                    // 最終的な位置を強制設定
                    marker.setLatLng(newLatLng);
                }
            }

            requestAnimationFrame(animateMove);
        }


      
      
        // イージング関数（既存）
        function easeInOutQuad(t) {
            return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
        }




        // ファイルアップロードの処理
        document.getElementById('fileUpload').addEventListener('change', function(evt) {
            var file = evt.target.files[0];
            if (!file) {
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, { type: 'array' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];
                var jsonData = XLSX.utils.sheet_to_json(worksheet);         
              
                
                // 以前のマーカーとチェックボックスをリセット
                if (window.categoryMarkers) {
                    Object.keys(window.categoryMarkers).forEach(function(category) {
                        window.categoryMarkers[category].forEach(function(marker) {
                            map.removeLayer(marker);
                        });
                    });
                }
                window.categoryMarkers = {};
                document.getElementById('pjList').innerHTML = '';

                // jsonDataを使ってカテゴリー別にチェックボックスとマーカーを作成
                jsonData.forEach(function(item, index) {
                    var category = item['Category 1'] ? item['Category 1'].trim() : ''; // カテゴリーの空チェック
                    if (!category || item['Category 1'] === 'n.a.') {
                        return; // カテゴリーが空、または'n.a.'の場合はスキップ
                    }
                    
                  
                    // Dataの読み込み　▼▼▼▼
                  
                    var category2 = item['Category 2'] && item['Category 2'] !== 'n.a.' ? item['Category 2'] : '';
                    var name = item['PJ name'] && item['PJ name'] !== 'n.a.' ? item['PJ name'] : '';
                    var siteName = item['Site name'] && item['Site name'] !== 'n.a.' ? item['Site name'] : '';
                    var country = item['Country'] && item['Country'] !== 'n.a.' ? item['Country'] : '';
                    var region = item['Region'] && item['Region'] !== 'n.a.' ? item['Region'] : '';
                    var adminDivision = item['Administrative Division'] && item['Administrative Division'] !== 'n.a.' ? item['Administrative Division'] : '';
                    var localDivision = item['Local Division'] && item['Local Division'] !== 'n.a.' ? item['Local Division'] : '';
                    var address = item['Address'] && item['Address'] !== 'n.a.' ? item['Address'] : '';                 
                    var location = [item['Latitude'], item['Longitude']];
                    var coordinates = item['Site Area'] && item['Site Area'] !== 'n.a.' ? item['Site Area'] : null;                    
                    var developer = item['Developer'] && item['Developer'] !== 'n.a.' ? item['Developer'] : '';
                    var units = item['Units'] && item['Units'] !== 'n.a.' ? item['Units'] : '';
                    // Unit Priceのフォーマット（$##,### /sqm）
                    var unitPrice = item['Unit Price'] && item['Unit Price'] !== 'n.a.' ? item['Unit Price'] : null;
                    if (unitPrice) {
                        unitPrice = parseFloat(unitPrice).toLocaleString('en-US', {
                            style: 'currency',
                            currency: 'USD',
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }) + ' /sqm';
                    }
                    var scale = item['Scale'] && item['Scale'] !== 'n.a.' ? item['Scale'] : '';
                    // Launchの日付フォーマット（mmmm, yyyy）
                    var launch = item['Launch'] && item['Launch'] !== 'n.a.' ? item['Launch'] : null;
                    if (launch) {
                        var launchDate = XLSX.SSF.parse_date_code(launch);
                        launch = new Date(launchDate.y, launchDate.m - 1).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    } 
                    var lastUpdate = item['Last Update'] && item['Last Update'] !== 'n.a.' ? item['Last Update'] : null;
                    if (lastUpdate) {
                        var lastUpdateDate = XLSX.SSF.parse_date_code(lastUpdate);
                        lastUpdate = new Date(lastUpdateDate.y, lastUpdateDate.m - 1).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    }
                    var architect = item['Architect'] && item['Architect'] !== 'n.a.' ? item['Architect'] : '';
                    var contractor = item['Contractor'] && item['Contractor'] !== 'n.a.' ? item['Contractor'] : '';
                    var sales = item['Sales Company'] && item['Sales Company'] !== 'n.a.' ? item['Sales Company'] : '';
                    var lastUpdate = item['Last Update'] && item['Last Update'] !== 'n.a.' ? item['Last Update'] : '';
                    var description = item['Description'] && item['Description'] !== 'n.a.' ? item['Description'] : '';
                    var googleMap = item['Google Map'] && item['Google Map'] !== 'n.a.' ? item['Google Map'] : '';
                    var link1 = item['Link 1'] && item['Link 1'] !== 'n.a.' ? item['Link 1'] : '';
                    var link2 = item['Link 2'] && item['Link 2'] !== 'n.a.' ? item['Link 2'] : '';
                    var link3 = item['Link 3'] && item['Link 3'] !== 'n.a.' ? item['Link 3'] : '';

                    console.log(parsedCoordinates); // 座標が正しいか確認
                    
                    // Dataの読み込み　▲▲▲▲
                    

                    

                    // ポップアップの内容をフォーマット
                    var popupContent = "<b>" + name + "</b><br>";
                    if (category2) {
                        popupContent += "<br>" + category2 + "<br>";
                    }
                    if (address) {
                        popupContent += "Location: " + address + "<br>";
                    }
                    if (scale) {
                        popupContent += "Scale: " + scale + "<br>";
                    }
                    if (developer) {
                        popupContent += "Developer: " + developer + "<br>";
                    }
                    if (architect) {
                        popupContent += "Architect: " + architect + "<br>";
                    }
                    if (contractor) {
                        popupContent += "Contractor: " + contractor + "<br>";
                    }
                    if (sales) {
                        popupContent += "Sales Company: " + sales + "<br>";
                    }
                    if (unitPrice) {
                        popupContent += "Unit Price: " + unitPrice + "<br>";
                    }
                    if (launch) {
                        popupContent += "Launch: " + launch + "<br>";
                    }
                    if (lastUpdate) {
                        popupContent += "Last Update: " + lastUpdate + "<br>";
                    }                   
                    if (description) {
                        popupContent += "<br>Note:<br>" + description + "<br>";
                    }
                    if (googleMap) {
                    popupContent += `<br><a href="${googleMap}" target="_blank"><img src="https://img.icons8.com/?size=100&id=FZi5imoPwGuZ&format=png&color=000000" alt="Google Map" style="width:20px;height:20px;"></a>`;
                    }
                    if (link1) {
                    popupContent += `　<a href="${link1}" target="_blank"><img src="https://img.icons8.com/?size=100&id=n9d0Hm43JCPK&format=png&color=000000" alt="Link 1" style="width:20px;height:20px;"></a>`;
                    }
                    if (link2) {
                    popupContent += `　<a href="${link2}" target="_blank"><img src="https://img.icons8.com/?size=100&id=n9d0Hm43JCPK&format=png&color=000000" alt="Link 2" style="width:20px;height:20px;"></a>`;
                    }
                    if (link3) {
                    popupContent += `　<a href="${link3}" target="_blank"><img src="https://img.icons8.com/?size=100&id=n9d0Hm43JCPK&format=png&color=000000" alt="Link 3" style="width:20px;height:20px;"></a>`;
                    }

                    

                    // カテゴリー1の値に基づいてアイコンURLを設定
                    var iconUrl = categoryIcons[category] || 'https://img.icons8.com/?size=100&id=bnfp2fmtrh0g&format=png&color=571601B8'; // デフォルトアイコン
                  
                    // アイコンのサイズ調整
                    var iconSize;
                    if (category === "Primary") {
                        iconSize = [20, 20]; // ECOBAのアイコンサイズを小さく
                    } else if (category === "PJ Site") {
                        iconSize = [0, 0]; // Other PJのアイコンサイズを小さく
                    } else if (category === "HC PJ") {
                        iconSize = [37, 37]; // HC PJのアイコンサイズを小さく
                    } else if (category === "Area") {
                        iconSize = [0, 0]; // Urban PJのアイコン
                    } else if (category === "Ecoba") {
                        iconSize = [20, 20]; // ECIOBA PJのアイコンサイズを小さく
                    } else if (category === "Condominium") {
                        iconSize = [20, 20]; // Condominiumのアイコンサイズを小さく
                    } else if (category === "Others") {
                        iconSize = [20, 20]; // Other PJのアイコンサイズを小さく
                    } else {
                        iconSize = [30, 30]; // それ以外は通常のサイズ
                    }

                    // アイコンを作成
                    var icon = L.icon({
                        iconUrl: iconUrl,
                        iconSize: iconSize,
                        iconAnchor: [12, iconSize[1]], // アイコンアンカーをサイズに合わせて調整
                        popupAnchor: [0, -iconSize[1]]
                    });

                    var marker = L.marker(location, { icon: icon }).bindPopup(popupContent);

                    //　ポップアップ生成
                    if (name && coordinates) {
                        try {
                            // JSON.parseでエラーが出た場合のフォールバック
                            var parsedCoordinates = typeof coordinates === "string" ? JSON.parse(coordinates) : coordinates;

                            // カテゴリー1の値に基づいて色を決定
                            var fillColor;
                            switch (category) {
                                case 'PJ Site':
                                    fillColor = '#FF0062A8'; // カテゴリーがPrimaryの場合の色
                                    break;
                                case 'HC PJ':
                                    fillColor = 'red'; // カテゴリーがHC PJの場合の色
                                    break;
                                case 'Area':
                                    fillColor = 'gold'; // カテゴリーがUrban PJの場合の色
                                    break;
                                default:
                                    fillColor = 'grey'; // その他の場合の色
                            }

                            // ポリゴンを追加
                            var polygon = L.polygon(parsedCoordinates, {
                                color: 'none',
                                weight: 0,
                                opacity: 0.8,
                                fillColor: fillColor,  // カテゴリーに応じた塗りつぶしの色
                                fillOpacity: 0.3
                            }).bindPopup(popupContent, {
                                className: 'polygon-popup' // カスタムクラスを割り当てる
                            });


                            polygon.addTo(map);

                            // ポリゴンをグローバルオブジェクトに登録
                            if (!window.categoryPolygons) {
                                window.categoryPolygons = {};
                            }
                            if (!window.categoryPolygons[category]) {
                                window.categoryPolygons[category] = [];
                            }
                            window.categoryPolygons[category].push(polygon);
                         
                        } catch (error) {
                            console.error(`Error parsing coordinates for ${name}:`, error);
                        }
                    }

                    // カテゴリーのリストに基づいてマーカーを管理
                    if (!window.categoryMarkers[category]) {
                        window.categoryMarkers[category] = [];
                    }
                    window.categoryMarkers[category].push(marker);
                    marker.addTo(map);

                    // 親チェックボックスの状態を子チェックボックスとポリゴンに反映する
                    document.querySelectorAll('.main-category input[type="checkbox"]').forEach(parentCheckbox => {
                        parentCheckbox.addEventListener('change', function() {
                            // 子チェックボックスを取得
                            const childCheckboxes = this.closest('.layer-group')
                                .querySelectorAll('.individual-icon-container input[type="checkbox"]');

                            // 親チェックボックスの状態に基づいて子チェックボックスを更新
                            const isChecked = this.checked;
                            childCheckboxes.forEach(cb => {
                                cb.checked = isChecked;
                                cb.dispatchEvent(new Event('change')); // 子の状態を反映させるためにイベント発火
                            });

                            // 親チェックボックスがポリゴンを制御
                            const category = this.id.replace('toggle', '').trim();
                            if (window.categoryMarkers[category]) {
                                window.categoryMarkers[category].forEach(marker => {
                                    if (isChecked) {
                                        marker.addTo(map); // ポリゴンを表示
                                    } else {
                                        map.removeLayer(marker); // ポリゴンを非表示
                                    }
                                });
                            }
                        });
                    });
      
    
                  
                    // For area-list-container                   
                    // エリアリストコンテナをクリア
                    const areaListContainer = document.getElementById('area-list-container');
                    areaListContainer.innerHTML = ''; // 既存のコンテンツをクリア

                    // 階層構造データを生成
                    createNestedList(jsonData, areaListContainer);

                    // 階層構造を生成する関数
                    function createNestedList(data, container) {
                        if (!name || name === "0" || name === "undefined") {
                            return; // 名前が無効の場合は生成しない
                        }                      
                      
                        // データをキーでグループ化するヘルパー関数
                        function groupBy(array, key) {
                            return array.reduce((result, current) => {
                                const groupKey = current[key];
                                if (!result[groupKey]) {
                                    result[groupKey] = [];
                                }
                                result[groupKey].push(current);
                                return result;
                            }, {});
                        }

                        // Countryレベルのグループ化
                        const countries = groupBy(data, 'Country');
                        Object.keys(countries).forEach(country => {
                            const countryDiv = createLayer('country-layer', country, countries[country], container);

                            // Regionレベルのグループ化
                            const regions = groupBy(countries[country], 'Region');
                            Object.keys(regions).forEach(region => {
                                const regionDiv = createLayer('region-layer', region, regions[region], countryDiv);

                                // Administrative Divisionレベルのグループ化
                                const admins = groupBy(regions[region], 'Administrative Division');
                                Object.keys(admins).forEach(admin => {
                                    const adminDiv = createLayer('admin-layer', admin, admins[admin], regionDiv);

                                    // Local Divisionレベルのグループ化
                                    const locals = groupBy(admins[admin], 'Local Division');
                                    Object.keys(locals).forEach(local => {
                                        createLayer('local-layer', local, locals[local], adminDiv);
                                    });
                                });
                            });
                        });
                    }

                    // 各レイヤー（階層）を生成する関数
                    function createLayer(className, name, items, parentElement) {
                        // 名前が無効な場合は生成しない
                        if (!name || name === "0" || name === "undefined") {
                            return;
                        }

                        const layerDiv = document.createElement('div');
                        layerDiv.className = className;

                        // チェックボックスとテキストを横並びにするためのコンテナ（左寄せ）
                        const checkboxContainer = document.createElement('div');
                        checkboxContainer.style.display = 'flex';
                        checkboxContainer.style.alignItems = 'center'; // アイテムを縦中央に配置
                        checkboxContainer.style.justifyContent = 'flex-start'; // アイテムを左寄せ
                        checkboxContainer.style.marginBottom = '5px'; // 各項目の間に少しスペースを追加

                        // チェックボックス
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = true;

                        // テキスト部分
                        const label = document.createElement('label');
                        label.textContent = ` ${name}`;
                        label.style.marginLeft = '5px';

                        // トグルアイコン（初期状態で下向きアイコン）
                        const toggleIcon = document.createElement('i');
                        toggleIcon.classList.add('toggle-icon', 'fa', 'fa-caret-down'); // 'toggle-icon'クラスを追加し、初期状態で下向き矢印
                        toggleIcon.style.marginLeft = '10px'; // アイコンの位置調整（テキストと少し間を開ける）

                        // 子要素コンテナ（子階層のアイテムを追加）
                        const childContainer = document.createElement('div');
                        childContainer.classList.add('child-container'); // CSSで指定したクラスを追加

                        // 開閉機能のイベントリスナー（トグルアイコンをクリックで開閉）
                        toggleIcon.addEventListener('click', () => {
                            const isOpen = childContainer.classList.contains('open');
                            // 開閉の状態に応じてクラスを切り替え
                            if (isOpen) {
                                childContainer.classList.remove('open');
                            } else {
                                childContainer.classList.add('open');
                            }

                            // アイコンの切り替え（上向き/下向き）
                            toggleIcon.classList.toggle('fa-caret-up', !isOpen);
                            toggleIcon.classList.toggle('fa-caret-down', isOpen);
                        });

                        // チェックボックスのイベントリスナー（マーカーの表示/非表示を制御）
                        checkbox.addEventListener('change', function () {
                            const isChecked = checkbox.checked;

                            // 子要素のチェックボックスを同期
                            const childCheckboxes = childContainer.querySelectorAll('input[type="checkbox"]');
                            childCheckboxes.forEach(cb => {
                                cb.checked = isChecked;
                                cb.dispatchEvent(new Event('change')); // 子要素にも変更を伝える
                            });

                            // 現在のレイヤー内のアイテムのマーカーとポリゴンを制御
                            items.forEach(item => {
                                // マーカーの検索と表示・非表示の制御
                                const marker = window.categoryMarkers?.[item['Category 1']]?.find(m =>
                                    m.getPopup().getContent().includes(item['PJ name'])
                                );
                                if (marker) {
                                    if (isChecked) {
                                        marker.addTo(map);
                                    } else {
                                        map.removeLayer(marker);
                                    }
                                }

                                // ポリゴンの検索と表示・非表示の制御
                                const polygon = window.categoryPolygons?.[item['Category 1']]?.find(p =>
                                    p.getPopup().getContent().includes(item['PJ name'])
                                );
                                if (polygon) {
                                    if (isChecked) {
                                        polygon.addTo(map);
                                    } else {
                                        map.removeLayer(polygon);
                                    }
                                }
                            });
                        });

                        // チェックボックス、テキスト、トグルアイコンを横並びに追加
                        checkboxContainer.appendChild(checkbox);
                        checkboxContainer.appendChild(label);
                        checkboxContainer.appendChild(toggleIcon);

                        // レイヤーを親要素に追加
                        layerDiv.appendChild(checkboxContainer);
                        layerDiv.appendChild(childContainer);
                        parentElement.appendChild(layerDiv);

                        return childContainer; // 子要素を追加するためのコンテナを返す
                    }         
                    // For area-list-container        
                  
                  
                    // カテゴリーごとのチェックボックスの生成（階層を保持）
                    // CategoryContainerを生成するコード
                    var categoryContainer = document.getElementById('categoryContainer' + category);
                    if (!categoryContainer) {
                        categoryContainer = document.createElement('div');
                        categoryContainer.id = 'categoryContainer' + category;
                        categoryContainer.className = 'layer-group';

                        var mainCategoryDiv = document.createElement('div');
                        mainCategoryDiv.className = 'main-category';
                        mainCategoryDiv.style.display = 'flex';
                        mainCategoryDiv.style.alignItems = 'center';

                        var categoryCheckbox = document.createElement('input');
                        categoryCheckbox.type = 'checkbox';
                        categoryCheckbox.id = 'toggle' + category;
                        categoryCheckbox.checked = true;

                        // テキスト部分をspan要素で囲む（ラベルから分離する）
                        var categoryText = document.createElement('span');
                        categoryText.className = 'category-text'; // テキスト部分にクラスを追加
                        categoryText.textContent = ' ' + category;

                        // mainCategoryDivにチェックボックスとテキストを追加
                        mainCategoryDiv.appendChild(categoryCheckbox);
                        mainCategoryDiv.appendChild(categoryText);
                        categoryContainer.appendChild(mainCategoryDiv);
                        document.getElementById('pjList').appendChild(categoryContainer);

                        // チェックボックスの状態によってマーカーを表示・非表示にするイベントリスナー
                        categoryCheckbox.addEventListener('change', function(e) {
                            if (e.target.checked) {
                                window.categoryMarkers[category].forEach(function(marker) { marker.addTo(map); });
                            } else {
                                window.categoryMarkers[category].forEach(function(marker) { map.removeLayer(marker); });
                            }

                            // 下位のチェックボックスにも同じ状態を適用
                            const subCheckboxes = categoryContainer.querySelectorAll('.individual-icon-container input[type="checkbox"]');
                            subCheckboxes.forEach(subCheckbox => {
                                subCheckbox.checked = e.target.checked;
                                // 下位のチェックボックスの変更に応じてマーカーも更新
                                if (subCheckbox.checked) {
                                    window.categoryMarkers[category].forEach(marker => marker.addTo(map));
                                } else {
                                    window.categoryMarkers[category].forEach(marker => map.removeLayer(marker));
                                }
                            });
                        });

                        // 開閉アイコンの作成
                        var toggleIcon = document.createElement('i');
                        toggleIcon.className = 'fa-solid fa-caret-down toggle-icon'; // クラス名を変更

                        // mainCategoryDivにcategoryTextの右側にアイコンを追加
                        mainCategoryDiv.appendChild(toggleIcon); // categoryTextの右側に追加

                        // 開閉機能の共通関数
                        function toggleIndividualContainers() {
                            const individualContainers = categoryContainer.querySelectorAll('.individual-icon-container');
                            let isOpen = false;

                            individualContainers.forEach(container => {
                                if (container.style.display === 'none' || container.style.display === '') {
                                    container.style.display = 'block'; // 開く
                                    isOpen = true;
                                } else {
                                    container.style.display = 'none'; // 閉じる
                                }
                            });

                            // アイコンの切り替えとスタイルの適用
                            toggleIcon.classList.toggle('fa-caret-down', !isOpen);
                            toggleIcon.classList.toggle('fa-caret-up', isOpen);
                        }

                        // category-textとtoggle-iconにクリックイベントを設定
                        categoryText.addEventListener('click', function(event) {
                            event.stopPropagation();
                            toggleIndividualContainers();
                        });

                        toggleIcon.addEventListener('click', function(event) {
                            event.stopPropagation();
                            toggleIndividualContainers();
                        });
                   }
                  









          
                  

                    // 各アイテムごとのチェックボックスとラベルの生成
                    var individualContainer = document.createElement('div');
                    individualContainer.className = 'individual-icon-container';
                    individualContainer.style.display = 'none'; // 初期状態は非表示に設定

                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = category + index;
                    checkbox.checked = true;
                    checkbox.className = 'individual-icon';
                    checkbox.addEventListener('change', function() {
                        if (checkbox.checked) {
                            marker.addTo(map);
                            polygon.addTo(map);
                        } else {
                            map.removeLayer(marker);
                            map.removeLayer(polygon);
                        }
                    });

                    var label = document.createElement('label');
                    label.htmlFor = category + index;
                    label.className = 'individual-icon';
                    label.appendChild(document.createTextNode(' ' + name));

                    // individual-iconクリックイベントをラベルに追加
                    label.addEventListener('click', function(event) {
                        event.preventDefault();  // チェックボックスの操作を防ぐ

                        // 対応するマーカーのカテゴリと名前を取得して特定
                        const marker = window.categoryMarkers[category]?.find(m => m.getPopup().getContent().includes(name));

                        if (marker) {
                            // マーカーの位置に地図を移動、アニメーションの速度を調整
                            map.flyTo(marker.getLatLng(), map.getZoom(), {
                                animate: true,
                                duration: 1.3 // 持続時間を秒単位で設定 (例: 2秒)
                            });
                            
                            // 地図の移動が終わった後にポップアップを開くための遅延を設定
                            setTimeout(() => {
                                marker.openPopup();
                            }, 1300); // flyToのdurationと同じ時間（1.3秒）を遅延させる                          
                        }
                    });

                    individualContainer.appendChild(checkbox);
                    individualContainer.appendChild(label);
                    categoryContainer.appendChild(individualContainer);

                });
              
              
                // カテゴリごとのマーカーを格納するオブジェクト
                if (!window.categoryMarkers) {
                    window.categoryMarkers = {};
                }

                function addMarkerToCategory(category, marker) {
                    if (!window.categoryMarkers[category]) {
                        window.categoryMarkers[category] = [];
                    }
                    window.categoryMarkers[category].push(marker);
                    console.log('window.categoryMarkers:', window.categoryMarkers);
                }      


                // トグル管理のコードをここに追加
                function setupToggle(containerId) {
                    const container = document.getElementById(containerId);

                    // トグルアイコンのクリックイベントを設定
                    container.addEventListener('click', (event) => {
                        if (event.target.classList.contains('toggle-icon')) {
                            const toggleIcon = event.target;
                            const childContainer = toggleIcon.closest('div').querySelector('.list-child-container');

                            // 開閉状態を切り替え
                            if (childContainer.classList.contains('open')) {
                                childContainer.classList.remove('open');
                            } else {
                                childContainer.classList.add('open');
                            }

                            // アイコンの向きを切り替え
                            toggleIcon.classList.toggle('fa-caret-up', !childContainer.classList.contains('open'));
                            toggleIcon.classList.toggle('fa-caret-down', childContainer.classList.contains('open'));
                        }
                    });

                    // チェックボックスの設定
                    container.addEventListener('change', (event) => {
                        if (event.target.type === 'checkbox') {
                            const checkbox = event.target;
                            const isChecked = checkbox.checked;

                            // 子要素のチェックボックスに状態を同期
                            const childCheckboxes = checkbox.closest('div').querySelectorAll('.child-container input[type="checkbox"]');
                            childCheckboxes.forEach(cb => {
                                cb.checked = isChecked;
                                cb.dispatchEvent(new Event('change')); // 子要素にも変更を伝える
                            });
                        }
                    });
                }              
            };
            reader.readAsArrayBuffer(file);

            // condoのチェックボックスでcondoのstatus制御
            document.getElementById('condo-category').addEventListener('change', function () {
                const condoStatus = document.getElementById('condoStatus');
                if (this.checked) {
                    condoStatus.style.display = 'block'; // Show the condoStatus element
                } else {
                    condoStatus.style.display = 'none'; // Hide the condoStatus element
                }
            });

            // Initialize the visibility on page load
            document.addEventListener('DOMContentLoaded', function () {
                const condoCategory = document.getElementById('condo-category');
                const condoStatus = document.getElementById('condoStatus');
                condoStatus.style.display = condoCategory.checked ? 'block' : 'none';
            });

            

            // 検索窓
            document.getElementById('pjSearch').addEventListener('input', function() {
                const searchValue = this.value.toLowerCase(); // Convert input to lowercase for case-insensitive search
                const projectItems = document.querySelectorAll('#pjList .individual-icon-container'); // All project containers

                projectItems.forEach(item => {
                    const projectName = item.textContent.trim().toLowerCase(); // Get the project name
                    if (projectName.includes(searchValue)) {
                        item.style.display = 'block'; // Show matching projects
                    } else {
                        item.style.display = 'none'; // Hide non-matching projects
                    }
                });
            });

            //　全開閉トグル
            document.getElementById('pjListToggleIcon').addEventListener('click', function () {
                const pjListContainer = document.getElementById('pjList');
                const individualContainers = pjListContainer.querySelectorAll('.individual-icon-container');
                const isOpen = this.classList.contains('fa-angles-up'); // Check the current state of the icon

                // Toggle the display of each tab
                individualContainers.forEach(container => {
                    container.style.display = isOpen ? 'none' : 'block';
                });

                // Update the icon to reflect the current state
                this.classList.toggle('fa-angles-up', !isOpen);
                this.classList.toggle('fa-angles-down', isOpen);
            });
            
            function createLayer(className, name, items, parentElement) {
                const layerDiv = document.createElement('div');
                layerDiv.className = className;

                // トグルアイコンの作成
                const toggleIcon = document.createElement('i');
                toggleIcon.classList.add('toggle-icon', 'fa', 'fa-caret-down');

                // 子要素コンテナ（.list-child-container）
                const childContainer = document.createElement('div');
                childContainer.classList.add('list-child-container');

                // トグルアイコンのクリックイベントで開閉
                toggleIcon.addEventListener('click', () => {
                    const isOpen = childContainer.classList.contains('open');

                    if (isOpen) {
                        // 閉じるアニメーション
                        childContainer.style.maxHeight = `${childContainer.scrollHeight}px`; // 現在の高さを固定
                        requestAnimationFrame(() => {
                            childContainer.style.maxHeight = '0'; // 高さを0に設定
                        });
                    } else {
                        // 開くアニメーション
                        childContainer.style.maxHeight = '0'; // 初期状態
                        requestAnimationFrame(() => {
                            childContainer.style.maxHeight = `${childContainer.scrollHeight}px`; // コンテンツの高さまで拡張
                        });
                    }

                    // 開閉状態を切り替え
                    childContainer.classList.toggle('open', !isOpen);

                    // アイコンの切り替え
                    toggleIcon.classList.toggle('fa-caret-up', !isOpen);
                    toggleIcon.classList.toggle('fa-caret-down', isOpen);
                });

                // レイヤーを親要素に追加
                layerDiv.appendChild(toggleIcon);
                layerDiv.appendChild(childContainer);
                parentElement.appendChild(layerDiv);

                return childContainer;
            }

            generatepjListData(); // 仮: `#pjList` のデータ生成関数
            generateAreaListData(); // 仮: `#area-list-container` のデータ生成関数              
            // `#pjList` と `#area-list-container` のトグル管理を設定
            setupToggle('pjList');
            setupToggle('area-list-container');
        }); 
      
      
      

// #conditions内のチェックボックスを#pjList内の要素とマーカーに連動させる
document.querySelectorAll('#conditions .c-checkbox input[type="checkbox"]').forEach(conditionCheckbox => {
    conditionCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;

        // 各条件のチェックボックスIDに応じたカテゴリ名を取得 (エクセルの入力も影響)
        let category;
        switch (this.id) {
            case 'primary-category':
                category = 'Primary';
                break;
            case 'condo-category':
                category = 'Condominium';
                break;
            case 'ecoba-category':
                category = 'Ecoba';
                break;
            case 'hc-category':
                category = 'Haseko';
                break;
            case 'areaDev-category':
                category = 'Area';
                break;
            case 'site-category':
                category = 'PJ Site';
                break;
            case 'other-category':
                category = 'Others';
                break;
            default:
                return; // マッチするものがない場合は処理を中断
        }

        // #pjList内の該当カテゴリの要素を取得して表示・非表示を切り替え
        const parentElement = document.querySelector(`#pjList .layer-group#categoryContainer${category}`);
        if (parentElement) {
            parentElement.style.display = isChecked ? 'block' : 'none';
        }

        // マーカーの表示・非表示を制御
        if (window.categoryMarkers && window.categoryMarkers[category]) {
            window.categoryMarkers[category].forEach(marker => {
                if (isChecked) {
                    marker.addTo(map); // マーカーを表示
                } else {
                    map.removeLayer(marker); // マーカーを非表示
                }
            });
        }

        // ポリゴンの表示・非表示も制御（必要に応じて）
        if (window.categoryPolygons && window.categoryPolygons[category]) {
            window.categoryPolygons[category].forEach(polygon => {
                if (isChecked) {
                    polygon.addTo(map); // ポリゴンを表示
                } else {
                    map.removeLayer(polygon); // ポリゴンを非表示
                }
            });
        }
    });
});
        

      
      
        // 画面ローテーションでリロード
        function handleOrientationChange() {
          if (window.matchMedia("(orientation: portait)").matches) {
            document.body.style.width = "100%";
          } else if (window.matchMedia("(orientation: landscape)").matches) {
            document.body.style.width = "100vw";
          }
        }

        window.addEventListener("orientationchange", handleOrientationChange);
        window.addEventListener("resize", handleOrientationChange);
        handleOrientationChange(); 
    </script>
</body>
</html>
